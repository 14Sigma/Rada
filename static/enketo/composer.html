<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<script src="../../js/jquery.min.js"
				type="text/javascript"></script>
		<script src="js/medic-enketo-offline-SNAPSHOT.min.js"
				type="text/javascript"></script>
		<link type="text/css" rel="stylesheet" href="style/enketo.css"/>
		<style>
			#control-panel {
				padding-top:5px;
			}
			#control-panel > tbody > tr > td {
				padding:10px;
				border: solid 1px #ccc;
			}
		</style>
	</head>
	<body>
		<div id="success-message" style="display:none">
			<h2>Form saved.</h2>
			<p>To fill another form, <a href='./composer.html'>click here</a></p>.
		</div>

		<div id="form-wrapper" style="display:none">
			<div class="container"></div>
			<div class="form-footer" style="margin:0">
				<input type="submit" value="Validate" class="btn btn-primary"/>
				<br/>
				<br/>
				<button class="btn btn-primary first-page">&lt;&lt; Go to start</button>
				<button class="btn btn-primary previous-page">&lt; prev</button>
				<button class="btn btn-primary next-page">next &gt;</button>
				<button class="btn btn-primary last-page">Go to end &gt;&gt;</button>
			</div>
		</div>

		<table id="control-panel"><tbody>
			<tr><td>
				<h2>Available forms</h2>
				<p class="status loading-forms">Loading forms...</p>
				<p class="status no-forms" style="display:none">There are currently no forms available.</p>
				<table id="form-examples"></table>
			</td></tr>
		</tbody></table>

		<script>
			window.medic_config = {
			  app_root: window.location.protocol + '//' + window.location.host,
			  db_root:  window.location.protocol + '//' + window.location.host + /^\/[^\/]+/.exec(window.location.pathname),
			};

			require.config({
			  shim: {
			    'jquery': {
			      exports: 'jQuery',
			    },
			    'widget/date/bootstrap3-datepicker/js/bootstrap-datepicker': {
			      deps: [ 'jquery' ],
			      exports: 'jQuery.fn.datepicker'
			    },
			    'widget/time/bootstrap3-timepicker/js/bootstrap-timepicker': {
			      deps: [ 'jquery' ],
			      exports: 'jQuery.fn.timepicker'
			    },
			    'leaflet': {
			      exports: 'L'
			    },
			  },
			});

			define('jquery', function() {
			  return jQuery;
			});

			requirejs(['jquery'], function($) {
			  function log(message) {
			    console.log('LOG | ' + message);
			  };
			  log('Scripts loaded.');

			  log('Requiring enketo form...');
			  requirejs(['enketo-js/Form'], function(Form) {
			    log('Enketo loaded.');

			    var showForm = function(formName, formHtml, formData) {
			      var form, formContainer, formWrapper,
			          init = function() {
			            var loadErrors;
			            form = new Form('#form-wrapper form', { modelStr:formData });
			            loadErrors = form.init();
			            if(loadErrors) log('loadErrors = ' + loadErrors);
			          },
			          xformDataAsJsonString = function(xml) {
			            return JSON.stringify({
			              form: formName,
			              type: 'data_record',
			              from: 'user:TODO',
			              reported_date: Date.now(),
			              content_type: 'xml',
			              content: xml,
			            });
			          };

			      log('Adding form to DOM...');
			      formWrapper = $('#form-wrapper');
			      formWrapper.show();
			      formContainer = formWrapper.find('.container');
			      formContainer.empty();

			      formContainer.append(formHtml);

			      log('Attempting to load form with data of type: ' + (typeof formData));
			      formData = formData;
			      console.log('form:\n' + formData);
			      init();

			      $('#form-wrapper input[type=submit]').on('click', function() {
			        form.validate();
			        if(form.isValid()) {
			          log('Form content is valid!  Saving and resetting.');
			          var record = xformDataAsJsonString(form.getDataStr()),
			              validateButton = $('#form-wrapper input[type=submit]');
			          validateButton.prop('disabled', true);
			          console.log('Submitting to db: ' + record);
			          $.ajax({
			            url: medic_config.db_root,
			            type: 'POST',
			            headers: {
			              'Content-Type': 'application/json',
			            },
			            data: record,
			            error: function(req, status, err) {
			                log('Error submitting form data: ' + err);
			                validateButton.prop('disabled', false); },
			            success: function() {
			                if(window === window.top) {
			                    form.resetView(); init();
			                    validateButton.prop('disabled', false);
			                } else {
			                    // in an iframe, so just show success message
			                    $('#success-message').show();
			                    $('#form-wrapper').hide();
			                }
			            },
			         });
			        } else {
			          log('Form contains errors.  Please correct them.');
			        }
			      });

			      // Hide loading section and instructions - hopefully the user knows what's
			      // going on by now.
			      $('#control-panel').remove();
			    };

			    var processors = {
			      html: { processor:new XSLTProcessor() },
			      model: { processor:new XSLTProcessor() } };
			    $.get('forms/openrosa2html5form.xsl').done(function(doc) {
			      processors.html.processor.importStylesheet(doc);
			      processors.html.loaded = true;
			    });
			    $.get('forms/openrosa2xmlmodel.xsl').done(function(doc) {
			      processors.model.processor.importStylesheet(doc);
			      processors.model.loaded = true;
			    });

			    var loadForm = function(name, url) {
			      if(!processors.html.loaded || !processors.model.loaded) {
			        return log('Not all processors are loaded yet.');
			      }

			      log('Loading form: ' + url + '...');
			      $.ajax(url).done(function(data) {
			        log('Loaded form.');
			        var doc = data,
			            html = processors.html.processor.transformToDocument(doc),
			            model = processors.model.processor.transformToDocument(doc);

			        console.log('XML');
			        console.log('---');
			        console.log(new XMLSerializer().serializeToString(model));

			        console.log('XML');
			        console.log('---');
			        console.log(new XMLSerializer().serializeToString(html));

			        showForm(name,
			            html.documentElement.innerHTML,
			            model.documentElement.innerHTML);
			      });
			    };

			    (function() {
			      var i, table = $('#form-examples'),
			          addFormToTable = function(id, name, url) {
			          table.append('<tr><td>' + name + '</td>' +
			              '<td><button class="btn btn-primary form-loader" onclick="loadXmlFrom(\'' + id + '\', \'' + url + '\')">load<button></td>' +
			              '</tr>');
			          };

			      window.loadXmlFrom = function(name, url) {
			        console.log('Should load from ' + url);
			        loadForm(name, url);
			      };

			      log('Fetching forms...');
			      (function() {
			        var formsVisible = false;
			        $.ajax({
			          url: medic_config.app_root + '/api/v1/forms',
			          headers: { 'X-OpenRosa-Version':'1.0' },
			          success: function(xml) {
			            var i, xform,
			                xforms = xml.getElementsByTagName('xform');
			            log('Loaded ' + xforms.length + ' forms from DB.');
			            for(i=0; i<xforms.length; ++i) {
			              xform = xforms[i];
			              addFormToTable(xform.getElementsByTagName('formID')[0].textContent,
			                  xform.getElementsByTagName('name')[0].textContent,
			                  xform.getElementsByTagName('downloadUrl')[0].textContent);
			            }
			            formsVisible = xforms.length > 0;
			          },
			          error: function(req, status, err) {
			              log('Error fetching forms: ' + err);
			              log('Status: ' + status);
			          },
			          complete: function() {
			              $('.loading-forms').hide();
			              if(!formsVisible) $('.no-forms').show();
			          },
			        });
			      }());
			    }());
			  });
			});
		</script>
	</body>
</html>
