/**
 * @license almond 0.3.1 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/**
 * XML merging class
 * Merge multiple XML sources
 * 
 * @package     MergeXML
 * @author      Vallo Reima
 * @copyright   (C)2014
 */

/**
     * Simple XPath Compatibility Plugin for jQuery 1.1
     * By John Resig
     * Dual licensed under MIT and GPL.
     * Original plugin code here: http://code.google.com/p/jqueryjs/source/browse/trunk/plugins/xpath/jquery.xpath.js?spec=svn3167&r=3167
     * some changes made by Martijn van de Rijdt (not replacing $.find(), removed context, dot escaping)
     *
     * @param  {string} selector [description]
     * @return {?(Array.<(Element|null)>|Element)}          [description]
     */

/**
 * @license RequireJS text 2.0.10 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/text for details
 */

/*!
 *
 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 * With parts by Tyler Close
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * With parts by Mark Miller
 * Copyright (C) 2011 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */

/*
* @fileOverview TouchSwipe - jQuery Plugin
* @version 1.6.5
*
* @author Matt Bryson http://www.github.com/mattbryson
* @see https://github.com/mattbryson/TouchSwipe-Jquery-Plugin
* @see http://labs.skinkers.com/touchSwipe/
* @see http://plugins.jquery.com/project/touchSwipe
*
* Copyright (c) 2010 Matt Bryson
* Dual licensed under the MIT or GPL Version 2 licenses.
*
*
* Changelog
* $Date: 2010-12-12 (Wed, 12 Dec 2010) $
* $version: 1.0.0
* $version: 1.0.1 - removed multibyte comments
*
* $Date: 2011-21-02 (Mon, 21 Feb 2011) $
* $version: 1.1.0 	- added allowPageScroll property to allow swiping and scrolling of page
*					- changed handler signatures so one handler can be used for multiple events
* $Date: 2011-23-02 (Wed, 23 Feb 2011) $
* $version: 1.2.0 	- added click handler. This is fired if the user simply clicks and does not swipe. The event object and click target are passed to handler.
*					- If you use the http://code.google.com/p/jquery-ui-for-ipad-and-iphone/ plugin, you can also assign jQuery mouse events to children of a touchSwipe object.
* $version: 1.2.1 	- removed console log!
*
* $version: 1.2.2 	- Fixed bug where scope was not preserved in callback methods.
*
* $Date: 2011-28-04 (Thurs, 28 April 2011) $
* $version: 1.2.4 	- Changed licence terms to be MIT or GPL inline with jQuery. Added check for support of touch events to stop non compatible browsers erroring.
*
* $Date: 2011-27-09 (Tues, 27 September 2011) $
* $version: 1.2.5 	- Added support for testing swipes with mouse on desktop browser (thanks to https://github.com/joelhy)
*
* $Date: 2012-14-05 (Mon, 14 May 2012) $
* $version: 1.2.6 	- Added timeThreshold between start and end touch, so user can ignore slow swipes (thanks to Mark Chase). Default is null, all swipes are detected
*
* $Date: 2012-05-06 (Tues, 05 June 2012) $
* $version: 1.2.7 	- Changed time threshold to have null default for backwards compatibility. Added duration param passed back in events, and refactored how time is handled.
*
* $Date: 2012-05-06 (Tues, 05 June 2012) $
* $version: 1.2.8 	- Added the possibility to return a value like null or false in the trigger callback. In that way we can control when the touch start/move should take effect or not (simply by returning in some cases return null; or return false;) This effects the ontouchstart/ontouchmove event.
*
* $Date: 2012-06-06 (Wed, 06 June 2012) $
* $version: 1.3.0 	- Refactored whole plugin to allow for methods to be executed, as well as exposed defaults for user override. Added 'enable', 'disable', and 'destroy' methods
*
* $Date: 2012-05-06 (Fri, 05 June 2012) $
* $version: 1.3.1 	- Bug fixes  - bind() with false as last argument is no longer supported in jQuery 1.6, also, if you just click, the duration is now returned correctly.
*
* $Date: 2012-29-07 (Sun, 29 July 2012) $
* $version: 1.3.2	- Added fallbackToMouseEvents option to NOT capture mouse events on non touch devices.
* 			- Added "all" fingers value to the fingers property, so any combination of fingers triggers the swipe, allowing event handlers to check the finger count
*
* $Date: 2012-09-08 (Thurs, 9 Aug 2012) $
* $version: 1.3.3	- Code tidy prep for minefied version
*
* $Date: 2012-04-10 (wed, 4 Oct 2012) $
* $version: 1.4.0	- Added pinch support, pinchIn and pinchOut
*
* $Date: 2012-11-10 (Thurs, 11 Oct 2012) $
* $version: 1.5.0	- Added excludedElements, a jquery selector that specifies child elements that do NOT trigger swipes. By default, this is one select that removes all form, input select, button and anchor elements.
*
* $Date: 2012-22-10 (Mon, 22 Oct 2012) $
* $version: 1.5.1	- Fixed bug with jQuery 1.8 and trailing comma in excludedElements
*					- Fixed bug with IE and eventPreventDefault()
* $Date: 2013-01-12 (Fri, 12 Jan 2013) $
* $version: 1.6.0	- Fixed bugs with pinching, mainly when both pinch and swipe enabled, as well as adding time threshold for multifinger gestures, so releasing one finger beofre the other doesnt trigger as single finger gesture.
*					- made the demo site all static local HTML pages so they can be run locally by a developer
*					- added jsDoc comments and added documentation for the plugin	
*					- code tidy
*					- added triggerOnTouchLeave property that will end the event when the user swipes off the element.
* $Date: 2013-03-23 (Sat, 23 Mar 2013) $
* $version: 1.6.1	- Added support for ie8 touch events
* $version: 1.6.2	- Added support for events binding with on / off / bind in jQ for all callback names.
*                   - Deprecated the 'click' handler in favour of tap.
*                   - added cancelThreshold property
*                   - added option method to update init options at runtime
*
* $version 1.6.3    - added doubletap, longtap events and longTapThreshold, doubleTapThreshold property
* $Date: 2013-04-04 (Thurs, 04 April 2013) $
* $version 1.6.4    - Fixed bug with cancelThreshold introduced in 1.6.3, where swipe status no longer fired start event, and stopped once swiping back.
*
* $Date: 2013-08-24 (Sat, 24 Aug 2013) $
* $version 1.6.5    - Merged a few pull requests fixing various bugs, added AMD support.

*/

/**
 * @preserve Copyright 2012 Martijn van de Rijdt & Modi Labs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

var requirejs,require,define;(function(e){function h(e,t){return f.call(e,t)}function p(e,t){var n,r,i,s,o,a,f,l,h,p,d,v=t&&t.split("/"),m=u.map,g=m&&m["*"]||{};if(e&&e.charAt(0)===".")if(t){e=e.split("/"),o=e.length-1,u.nodeIdCompat&&c.test(e[o])&&(e[o]=e[o].replace(c,"")),e=v.slice(0,v.length-1).concat(e);for(h=0;h<e.length;h+=1){d=e[h];if(d===".")e.splice(h,1),h-=1;else if(d===".."){if(h===1&&(e[2]===".."||e[0]===".."))break;h>0&&(e.splice(h-1,2),h-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((v||g)&&m){n=e.split("/");for(h=n.length;h>0;h-=1){r=n.slice(0,h).join("/");if(v)for(p=v.length;p>0;p-=1){i=m[v.slice(0,p).join("/")];if(i){i=i[r];if(i){s=i,a=h;break}}}if(s)break;!f&&g&&g[r]&&(f=g[r],l=h)}!s&&f&&(s=f,a=l),s&&(n.splice(0,a,s),e=n.join("/"))}return e}function d(t,r){return function(){var i=l.call(arguments,0);return typeof i[0]!="string"&&i.length===1&&i.push(null),n.apply(e,i.concat([t,r]))}}function v(e){return function(t){return p(t,e)}}function m(e){return function(t){s[e]=t}}function g(n){if(h(o,n)){var r=o[n];delete o[n],a[n]=!0,t.apply(e,r)}if(!h(s,n)&&!h(a,n))throw new Error("No "+n);return s[n]}function y(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function b(e){return function(){return u&&u.config&&u.config[e]||{}}}var t,n,r,i,s={},o={},u={},a={},f=Object.prototype.hasOwnProperty,l=[].slice,c=/\.js$/;r=function(e,t){var n,r=y(e),i=r[0];return e=r[1],i&&(i=p(i,t),n=g(i)),i?n&&n.normalize?e=n.normalize(e,v(t)):e=p(e,t):(e=p(e,t),r=y(e),i=r[0],e=r[1],i&&(n=g(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},i={require:function(e){return d(e)},exports:function(e){var t=s[e];return typeof t!="undefined"?t:s[e]={}},module:function(e){return{id:e,uri:"",exports:s[e],config:b(e)}}},t=function(t,n,u,f){var l,c,p,v,y,b=[],w=typeof u,E;f=f||t;if(w==="undefined"||w==="function"){n=!n.length&&u.length?["require","exports","module"]:n;for(y=0;y<n.length;y+=1){v=r(n[y],f),c=v.f;if(c==="require")b[y]=i.require(t);else if(c==="exports")b[y]=i.exports(t),E=!0;else if(c==="module")l=b[y]=i.module(t);else if(h(s,c)||h(o,c)||h(a,c))b[y]=g(c);else{if(!v.p)throw new Error(t+" missing "+c);v.p.load(v.n,d(f,!0),m(c),{}),b[y]=s[c]}}p=u?u.apply(s[t],b):undefined;if(t)if(l&&l.exports!==e&&l.exports!==s[t])s[t]=l.exports;else if(p!==e||!E)s[t]=p}else t&&(s[t]=u)},requirejs=require=n=function(s,o,a,f,l){if(typeof s=="string")return i[s]?i[s](o):g(r(s,o).f);if(!s.splice){u=s,u.deps&&n(u.deps,u.callback);if(!o)return;o.splice?(s=o,o=a,a=null):s=e}return o=o||function(){},typeof a=="function"&&(a=f,f=l),f?t(e,s,o,a):setTimeout(function(){t(e,s,o,a)},4),n},n.config=function(e){return n(e)},requirejs._defined=s,define=function(e,t,n){if(typeof e!="string")throw new Error("See almond README: incorrect module build, no module name");t.splice||(n=t,t=[]),!h(s,e)&&!h(o,e)&&(o[e]=[e,t,n])},define.amd={jQuery:!0}})(),define("../../lib/almond",function(){}),function(e,t){"use strict";typeof define=="function"&&define.amd?define("merge-xml",[],t):typeof exports=="object"?module.exports=t():e.MergeXML=t()}(this,function(){return function(e){var t,n,r,i,s,o,u="_",a,f,l,c=1,h=3,p=8,d=7,v=this;v.Init=function(){return v.dom=null,v.nsp={},v.count=0,f[1]=!1,t>0&&(v.error={code:"",text:""}),t>0},v.AddFile=function(e){var t;return!e||!e.target?t=N("nof"):e.target.result?t=v.AddSource(e.target.result):t=N("emf"),t},v.AddSource=function(e){var n,r;if(typeof e=="object")r=v.Get(1,e)?e:!1,r&&(t===1&&!window.DOMParser||t===2&&!r.selectSingleNode("/"))&&(r=null);else try{r=m(e)}catch(i){r=!1}if(r===null)n=N("nos");else if(r===!1)n=N("inv");else if(r===!0)v.nsp=E(v.dom.documentElement),v.count=1,n=v.dom;else if(y(r)){b(r,"/");if(f[1]===!0){var s=v.dom.createTextNode("\r\n");v.dom.documentElement.appendChild(s)}v.count++,n=v.dom}else n=!1;return n};var m=function(e){var i,s;return t===1?v.dom?(s=r.parseFromString(e,"text/xml"),i=g(s)?s:!1):(v.dom=r.parseFromString(e,"text/xml"),i=g(v.dom)?!0:!1):v.dom?(s=new ActiveXObject(n),s.async=!1,i=s.loadXML(e)?s:!1):(v.dom=new ActiveXObject(n),v.dom.async=!1,v.dom.setProperty("SelectionLanguage","XPath"),i=v.dom.loadXML(e)?!0:!1),i},g=function(e){return e.getElementsByTagNameNS(i,"parsererror").length===0},y=function(e){var n=!0;if(e.inputEncoding!==v.dom.inputEncoding||e.xmlEncoding!==v.dom.xmlEncoding)n=N("enc");else if(e.documentElement.namespaceURI!==v.dom.documentElement.namespaceURI)n=N("nse");else if(e.documentElement.nodeName!==v.dom.documentElement.nodeName)if(!f[0])n=N("dif");else if(!f[1]){var r=v.dom.inputEncoding?v.dom.inputEncoding:v.dom.xmlEncoding?v.dom.xmlEncoding:"utf-8",i=v.dom.xmlVersion?v.dom.xmlVersion:"1.0",s='<?xml version="'+i+'" encoding="'+r+'"?>\r\n<'+f[0]+">\r\n</"+f[0]+">",u=m(s);if(u){var a=v.dom.documentElement.cloneNode(!0);u.documentElement.appendChild(a),a=u.createTextNode("\r\n"),u.documentElement.appendChild(a),v.dom=u,f[1]=!0}else n=N("jne"),f[1]=null}if(n){var c=E(e.documentElement);for(var h in c)v.nsp[h]||(v.dom.documentElement.setAttribute("xmlns:"+h,c[h]),v.nsp[h]=c[h]);l?t===1?o=S:x():o=null}return n},b=function(e,t){for(var n=0;n<e.childNodes.length;n++){var r,i=e.childNodes[n],s=w(e.childNodes,i,t,n),o=v.Query(s);if(i.nodeType===c){var u=!0;if(o===null||o.namespaceURI!==i.namespaceURI)r=i.cloneNode(!0),o=v.Query(t),o.appendChild(r);else{T(o.getAttribute("stay"),a)!==!1&&(u=!1);if(u)try{for(var f=0;f<i.attributes.length;f++)o.setAttribute(i.attributes[f].nodeName,i.attributes[f].nodeValue)}catch(l){}}i.hasChildNodes()&&u&&b(i,s)}else if(i.nodeType===h||i.nodeType===p)o===null||o.nodeType!==i.nodeType?(o=v.Query(t),i.nodeType===h?r=v.dom.createTextNode(i.nodeValue):r=v.dom.createComment(i.nodeValue),o.appendChild(r)):o.nodeValue=i.nodeValue}},w=function(e,n,r,i){var s,o,a=0;if(n.nodeType===c){for(o=0;o<=i;o++)(l&&e[o].nodeType===n.nodeType&&e[o].nodeName===n.nodeName||!l&&e[o].nodeType!==d)&&a++;if(l){var f=!1,m=E(n);for(var g in m)g!==u&&(v.nsp[g]=m[g],f=t===2);f&&x(),n.prefix?s=n.prefix+":":v.nsp[u]?s=u+":":s="",s+=n.localName?n.localName:n.baseName}else s="node()"}else if(n.nodeType===h||n.nodeType===p){for(o=0;o<=i;o++)e[o].nodeType===n.nodeType&&a++;s=n.nodeType===h?"text()":"comment()"}else s=r;return a&&(s=r+(r.slice(-1)==="/"?"":"/")+s+"["+a+"]"),s},E=function(e){var t={},n=e.attributes;for(var r=0;r<n.length;++r){var i=n[r].name.split(":");if(i[0]==="xmlns"){var s=i[1]?i[1]:u;t[s]=n[r].value}}return t};v.Query=function(e){var n;f[1]&&(e="/"+v.dom.documentElement.nodeName+(e==="/"?"":e));try{t===1?(n=s.evaluate(e,v.dom,o,XPathResult.FIRST_ORDERED_NODE_TYPE,null),n=n.singleNodeValue):n=v.dom.selectSingleNode(e)}catch(r){n=null}return n};var S=function(e){return v.nsp[e]||null},x=function(){var e="";for(var t in v.nsp)e+=" xmlns:"+t+"="+"'"+v.nsp[t]+"'";e&&v.dom.setProperty("SelectionNamespaces",e.substr(1))},T=function(e,t){var n=!1;for(var r in e)if(e[r]===t){n=r;break}return n};v.Get=function(e,t){var n;e&&!t&&(t=v.dom);if(!e)n=v.dom;else if(!t)n="";else if(t.xml)n=t.xml;else try{n=(new XMLSerializer).serializeToString(t)}catch(r){n=null}if(n&&e===2){if(f[1]){var i=n.indexOf("<"+f[0]);n=n.substr(0,i)+"\r\n"+n.substr(i)}n=n.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/ |\t/g,"&nbsp;"),n=n.replace(/(\r\n|\n|\r)/g,"<br>")}return n};var N=function(e){var t={nod:"XML DOM is not supported in this browser",nox:"xPath is not supported in this browser",nos:"Incompatible source object",nof:"File not found",emf:"File is empty",inv:"Invalid XML source",enc:"Different encoding",dif:"Different root nodes",jne:"Invalid join parameter",nse:"Namespace incompatibility",und:"Undefined error"};return v.error.code=t[e]?e:"und",v.error.text=t[v.error.code],!1},C=function(){var e,t=!1,o=["MSXML2.DOMDocument.6.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","Microsoft.XmlDom"],u=o.length;for(var a=0;a<u;a++)try{var f=new ActiveXObject(o[a]);f.async=!1,t=!0;if(f.loadXML("<x></x>")&&f.selectSingleNode("/"))break}catch(l){}if(t)a<u?(n=o[a],e=2):e="nox";else if(!window.DOMParser)e="nod";else if(!window.XPathEvaluator)e="nox";else{r=new DOMParser;var l=r.parseFromString("Invalid","text/xml");i=l.getElementsByTagName("parsererror")[0].namespaceURI,s=new XPathEvaluator,e=1}return e};typeof e!="object"&&(e={}),typeof e.stay=="undefined"?a=["all"]:e.stay?typeof e.stay=="object"&&e.stay instanceof Array?a=e.stay:a=[e.stay]:a=[],typeof e.join=="undefined"?f=["root"]:f=[e.join?String(e.join):!1],typeof e.updn=="undefined"?l=!0:l=e.updn,t=C(),typeof t=="string"&&(v.error={},N(t),t=0),v.Init()}}),define("enketo-js/utils",[],function(){function e(e,t){var n,r,i,s,o=new RegExp(t+"\\s*\\(","g"),u=[];if(!e||!t)return u;while((r=o.exec(e))!==null){i=1,s=r.index,n=o.lastIndex;while(i!==0)n++,e[n]==="("?i++:e[n]===")"&&i--;u.push([e.substring(s,n+1),e.substring(o.lastIndex,n).trim()])}return u}return{parseFunctionFromExpression:e}});var raw_string_singles=/^\s*'([^']*)'\s*$/,raw_string_doubles=/^\s*"([^"]*)"\s*$/,raw_number=/^\s*([0-9]+)\s*$/,boolean_from_string=/^boolean-from-string\((.*)\)$/,int=/^int\((.*)\)$/,pow=/^pow\((.*),\s*(.*)\)$/,concat=/^concat\((.*),\s*(.*)\)$/,selected=/^selected\((.*),\s*(.*)\)$/,regex=/^regex\((.*),\s*(.*)\)$/,infix=/^(.*)\s*((?:<|&lt;|>|&gt;)=?)\s*(.*)$/,coalesce=/^coalesce\((.*),\s*(.*)\)$/,substr=/^substr\(([^,]*),\s*([^,]*)(?:,\s*(.*))?\)$/,_uuid_part=function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)},uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,_uuid_part)},xpathResult={"boolean":function(e){return{resultType:XPathResult.BOOLEAN_TYPE,booleanValue:e,stringValue:e.toString()}},number:function(e){return{resultType:XPathResult.NUMBER_TYPE,numberValue:e,stringValue:e.toString()}},string:function(e){return{resultType:XPathResult.STRING_TYPE,stringValue:e}}},zeroPad=function(e){return e>=10?e:"0"+e},textVal=function(e){switch(e.resultType){case XPathResult.UNORDERED_NODE_ITERATOR_TYPE:case XPathResult.ORDERED_NODE_ITERATOR_TYPE:case XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE:case XPathResult.ORDERED_NODE_SNAPSHOT_TYPE:case XPathResult.ANY_UNORDERED_NODE_TYPE:case XPathResult.FIRST_ORDERED_NODE_TYPE:return console.log("We got a node of type: "+e.resultType),e.iterateNext().textContent}return e.stringValue},openrosa_xpath=function(e,t,n,r,i){"use strict";var s=this,o,u,a,f,l=s?s.evaluate:null,c=function(e,r){return r||(r=XPathResult.ANY_TYPE),openrosa_xpath.call(s,e,t,n,r,i)};if(e==="uuid()")return xpathResult.string(uuid());if(e==="random()")return xpathResult.number(Math.random());if(e==="now()")return xpathResult.number(Date.now());if(e==="today()"){var h=new Date;return h=h.getFullYear()+"-"+zeroPad(h.getMonth()+1)+"-"+zeroPad(h.getDate()),xpathResult.string(h)}o=infix.exec(e);if(o){var p=c(o[1]),d=o[2],v=c(o[3]);switch(d){case"<":case"&lt;":p.resultType===XPathResult.NUMBER_TYPE&&v.resultType===XPathResult.NUMBER_TYPE?u=p.numberValue<v.numberValue:u=textVal(p)<textVal(v);break;case"<=":case"&lt;=":p.resultType===XPathResult.NUMBER_TYPE&&v.resultType===XPathResult.NUMBER_TYPE?u=p.numberValue<=v.numberValue:u=textVal(p)<=textVal(v);break;case">":case"&gt;":p.resultType===XPathResult.NUMBER_TYPE&&v.resultType===XPathResult.NUMBER_TYPE?u=p.numberValue>v.numberValue:u=textVal(p)>textVal(v);break;case">=":case"&gt;=":p.resultType===XPathResult.NUMBER_TYPE&&v.resultType===XPathResult.NUMBER_TYPE?u=p.numberValue>=v.numberValue:u=textVal(p)>=textVal(v)}return typeof u=="undefined"?xpathResult.string("Not yet implemented"):xpathResult.boolean(u)}o=raw_number.exec(e);if(o)return xpathResult.number(o[1]);o=raw_string_singles.exec(e);if(o)return xpathResult.string(o[1]);o=raw_string_doubles.exec(e);if(o)return xpathResult.string(o[1]);o=int.exec(e);if(o)return u=c(o[1],XPathResult.STRING_TYPE).stringValue,xpathResult.number(parseInt(u,10));o=boolean_from_string.exec(e);if(o)return u=c(o[1],XPathResult.STRING_TYPE).stringValue,xpathResult.boolean(u==="1"||u==="true");o=selected.exec(e);if(o){var m=c(o[1],XPathResult.STRING_TYPE).stringValue.split(" "),g=c(o[2],XPathResult.STRING_TYPE).stringValue;return xpathResult.boolean(m.indexOf(g)!==-1)}o=concat.exec(e);if(o)return a=c(o[1],XPathResult.STRING_TYPE).stringValue+c(o[2],XPathResult.STRING_TYPE).stringValue,xpathResult.string(a);o=pow.exec(e);if(o)return u=c(o[1],XPathResult.STRING_TYPE).stringValue,a=Math.pow(parseInt(u,10),parseInt(o[2],10)),xpathResult.number(a);o=regex.exec(e);if(o)return a=c(o[1],XPathResult.STRING_TYPE).stringValue,f=c(o[2],XPathResult.STRING_TYPE).stringValue,xpathResult.boolean((new RegExp(f)).test(a));o=coalesce.exec(e);if(o)return u=c(o[1],XPathResult.STRING_TYPE),u.stringValue?u:(u=c(o[2],XPathResult.STRING_TYPE),u);o=substr.exec(e);if(o){u=c(o[1],XPathResult.STRING_TYPE).stringValue;var y=parseInt(o[2],10),b=o[3]?parseInt(o[3],10):u.length;return a=u.slice(y,b),xpathResult.string(a)}if(l)return l.apply(s,arguments);throw new Error("Failed to parse expression: ["+e+"]")};typeof define=="function"?define("openrosa-xpath",[],function(){return openrosa_xpath}):typeof module=="object"&&typeof module.exports=="object"&&(module.exports=openrosa_xpath),define("enketo-js/plugins",["jquery"],function(e){e.fn.clearInputs=function(t){return t=t||"edit",this.each(function(){e(this).find(".file-preview").remove(),e(this).find("input, select, textarea").not(".ignore").each(function(){var n=e(this),r=n.attr("type");n.prop("nodeName").toUpperCase()==="SELECT"&&(r="select"),n.prop("nodeName").toUpperCase()==="TEXTAREA"&&(r="textarea");switch(r){case"date":case"datetime":case"time":case"number":case"search":case"color":case"range":case"url":case"email":case"password":case"text":case"file":n.removeAttr("data-previous-file-name data-loaded-file-name");case"hidden":case"textarea":n.val()!==""&&n.val("").trigger(t);break;case"radio":case"checkbox":n.prop("checked")&&(n.prop("checked",!1),n.trigger(t));break;case"select":n[0].selectedIndex>=0&&(n[0].selectedIndex=-1,n.trigger(t));break;default:console.error("Unrecognized input type found when trying to reset",this)}})})},e.fn.markdownToHtml=function(){return this.each(function(){var t,n=e("<div/>");e(this).children(":not(input, select, textarea)").each(function(t){var r="$$$"+t;e(this).clone().markdownToHtml().appendTo(n),e(this).replaceWith(r)}),t=e(this).html(),t=t.replace(/__([^\s][^_]*[^\s])__/gm,"<strong>$1</strong>"),t=t.replace(/\*\*([^\s][^\*]*[^\s])\*\*/gm,"<strong>$1</strong>"),t=t.replace(/_([^\s][^_]*[^\s])_/gm,"<em>$1</em>"),t=t.replace(/\*([^\s][^\*]*[^\s])\*/gm,"<em>$1</em>"),t=t.replace(/\[([^\]]*)\]\(([^\)]+)\)/gm,'<a href="$2" target="_blank">$1</a>'),t=t.replace(/\n/gm,"<br />"),n.children().each(function(n){var r=new RegExp("\\$\\$\\$"+n);t=t.replace(r,e(this)[0].outerHTML)}),e(this).text("").append(t)})},e.fn.reverse=[].reverse}),define("enketo-js/extend",["require"],function(e){String.prototype.pad=function(e){var t=this;while(t.length<e)t="0"+t;return t},Date.prototype.toISOLocalString=function(){var e={},t=function(e){return e<10?"0"+e:e};return this.toString()==="Invalid Date"?this.toString():(e.minstotal=this.getTimezoneOffset(),e.direction=e.minstotal<0?"+":"-",e.hrspart=t(Math.abs(Math.floor(e.minstotal/60))),e.minspart=t(Math.abs(Math.floor(e.minstotal%60))),(new Date(this.getTime()-e.minstotal*60*1e3)).toISOString().replace("Z",e.direction+e.hrspart+":"+e.minspart))}}),function(e){typeof define=="function"&&define.amd?define("jquery.xpath",["jquery"],e):e(jQuery)}(function(e){e.fn.getXPath=function(e,t){var n,r=[],i="",s=this.first(),o=s.prop("nodeName"),u=s.parent(),a=u.prop("nodeName");e=e||"#document",t=t||!1,t&&(n=s.siblings(o).addBack(),i=n.length>1?"["+(n.index(s)+1)+"]":""),r.push(o+i);while(u.length==1&&a!==e&&a!=="#document")t&&(n=u.siblings(a).addBack(),i=n.length>1?"["+(n.index(u)+1)+"]":""),r.push(a+i),u=u.parent(),a=u.prop("nodeName");return"/"+r.reverse().join("/")},e.fn.xfind=function(e){var t,n,r;e=e.replace(/\/\//g," "),e=e.replace(/^\//,""),e=e.replace(/\/\.$/,""),e=e.replace(/\//g,">"),e=e.replace(/\[([^@].*?)\]/g,function(e,t){return":has("+t+")"});if(e.indexOf(">..")>=0){t=e.split(/>\.\.>?/g),n=jQuery(t[0],this);for(r=1;r<t.length;r++)n=n.parent(t[r]);return n.get()}return e=e.replace(/\./gi,"\\."),this.find(e)}}),define("enketo-js/FormModel",["merge-xml","enketo-js/utils","jquery","openrosa-xpath","enketo-js/plugins","enketo-js/extend","jquery.xpath"],function(e,t,n,r){"use strict";var i,s,o;return i=function(e,t){typeof e=="string"&&(e={modelStr:e}),e.external=e.external||[],e.submitted=typeof e.submitted!="undefined"?e.submitted:!0,t=t||{},t.full=typeof t.full!="undefined"?t.full:!0,this.convertedExpressions={},this.templates={},this.loadErrors=[],this.INSTANCE=/instance\([\'|\"]([^\/:\s]+)[\'|\"]\)/g,this.OPENROSA=/(decimal-date-time\(|pow\(|indexed-repeat\(|format-date\(|coalesce\(|join\(|max\(|min\(|random\(|substr\(|int\(|uuid\(|regex\(|now\(|today\(|date\(|if\(|boolean-from-string\(|checklist\(|selected\(|selected-at\(|round\(|area\(|position\([^\)])/,this.data=e,this.options=t},i.prototype.init=function(){var e,t,r,i=this;this.data.modelStr=this.data.modelStr.replace(/\s(xmlns\=("|')[^\s\>]+("|'))/g," data-$1"),this.options.full||(this.data.modelStr=this.data.modelStr.replace(/^(<model\s*><instance((?!<instance).)+<\/instance\s*>\s*)(<instance.+<\/instance\s*>)*/,"$1"));try{e="model",this.xml=n.parseXML(this.data.modelStr),this.data.external.forEach(function(s){e='instance "'+s.id+'"'||"instance unknown",t=i.xml.getElementById(s.id),r=t.querySelector("root"),r&&t.removeChild(r),t.appendChild(n.parseXML(s.xmlStr).firstChild)})}catch(s){console.error(s),this.loadErrors.push("Error trying to parse XML "+e+". "+s.message)}if(this.xml){this.$=n(this.xml),this.hasInstance=!!this.xml.querySelector("model > instance")||!1,this.rootElement=this.xml.querySelector("instance > *")||this.xml.documentElement,this.$.find("model > instance[src]:empty").each(function(e,t){i.loadErrors.push('External instance "'+n(t).attr("id")+'" is empty.')}),this.trimValues(),this.cloneAllTemplates(),this.extractTemplates();try{e="record",this.data.instanceStr&&(this.mergeXml(this.data.instanceStr),this.data.submitted&&this.deprecateId())}catch(s){console.error(s),this.loadErrors.push("Error trying to parse XML "+e+". "+s.message)}}return this.loadErrors},i.prototype.node=function(e,t,n){return new s(e,t,n,this)},i.prototype.mergeXml=function(t){var n,r,i,s;if(!t)return;i=this.xml.querySelector("instance"),s=this.xml.querySelector("instance > *");if(!s)throw new Error("Model is corrupt. It does not contain a childnode of instance");r=new e({join:!1}),n=(new XMLSerializer).serializeToString(s),r.AddSource(n),r.AddSource(t);if(r.error.code)throw new Error(r.error.text);this.xml.querySelector("instance").removeChild(s),s=this.xml.adoptNode(r.Get(0).documentElement,!0),i.appendChild(s),this.rootElement=s},i.prototype.trimValues=function(){this.node(null,null,{noEmpty:!0}).get().each(function(){this.textContent=this.textContent.trim()})},i.prototype.deprecateId=function(){var e,t,r,i,s;e=this.xml.querySelectorAll("* > meta > instanceID");if(e.length!==1)throw new Error("Invalid primary instance. Found "+e.length+" instanceID nodes but expected 1.");t=e[0],r=this.xml.querySelectorAll("* > meta > deprecatedID");if(r.length>1)throw new Error("Invalid primary instance. Found "+r.length+" deprecatedID nodes but expected 1.");i=r[0],i||(i=n.parseXML("<deprecatedID/>").documentElement,this.xml.adoptNode(i),s=this.xml.querySelector("* > meta"),s.appendChild(i)),i.textContent=t.textContent,t.textContent=""},i.prototype.bindJsEvaluator=function(){var e=new XPathEvaluator;this.xml.jsCreateExpression=function(){return e.createExpression.apply(e,arguments)},this.xml.jsCreateNSResolver=function(){return e.createNSResolver.apply(e,arguments)},console.log("i am the eggman"),this.xml.jsEvaluate=r,window.JsXPathException=window.JsXPathExpression=window.JsXPathNSResolver=window.JsXPathResult=window.JsXPathNamespace=!0},i.prototype.getInstanceID=function(){return this.node("/*/meta/instanceID").getVal()[0]},i.prototype.getInstanceName=function(){return this.node("/*/meta/instanceName").getVal()[0]},i.prototype.cloneRepeat=function(e,t){var r,i,s,o,u=this.templates[e]||this.node(e,0).get(),a=this;i=u.prop("nodeName"),r=this.node(e,t).get(),u[0]&&r.length===1&&r.nextAll(i).length===0?(o=u.clone().insertAfter(r),s=[u.prop("nodeName")],u.find("*").each(function(){s.push(n(this).prop("nodeName"))}),this.$.trigger("dataupdate",{nodes:s,repeatPath:e,repeatIndex:a.node(e,t).determineIndex(o)})):r.nextAll(i).length===0&&console.error("Could not find template node and/or node to insert the clone after")},i.prototype.extractTemplates=function(){var e=this;this.evaluate("/model/instance[1]/*//*[@template] | /model/instance[1]/*//*[@jr:template]","nodes",null,null,!0).reverse().forEach(function(t){var r=n(t);e.templates[r.getXPath("instance")]=r.removeAttr("template").removeAttr("jr:template").remove()})},i.prototype.getTemplatePath=function(e){var t,n=this;return e.split("/").some(function(e,r,i){return t=i.slice(0,i.length-r).join("/"),n.templates[t]}),t||undefined},i.prototype.cloneAllTemplates=function(){var e=this;this.evaluate("/model/instance[1]/*//*[@template] | /model/instance[1]/*//*[@jr:template]","nodes",null,null,!0).forEach(function(t){var r=t.nodeName,i=n(t).getXPath("instance"),s=e.evaluate("ancestor::"+r+"[@template] | ancestor::"+r+"[@jr:template]","nodes",i,0,!0);s.length===0&&n(t).siblings(r).length===0&&n(t).clone().insertAfter(n(t)).find("*").addBack().removeAttr("template").removeAttr("jr:template")})},i.prototype.get=function(){return this.$||null},i.prototype.getXML=function(){return this.xml||null},i.prototype.getStr=function(){var e=(new XMLSerializer).serializeToString(this.xml.querySelector("instance > *")||this.xml.documentElement,"text/xml");return e=e.replace(/\t/g,""),e=e.replace(/\s(data-)(xmlns\=("|')[^\s\>]+("|'))/g," $2"),e},i.prototype.makeBugCompliant=function(e,t,n){var r,i,s,o,u,a,f,l;o=this.node(t,n).get(),l=o.parents().add(o);for(r=l.length-1;r>=0;r--)u=l.eq(r),a=u.prop("nodeName").replace(/\./g,"\\."),f=u.siblings(a).not("[template]"),a.toLowerCase()!=="instance"&&a.toLowerCase()!=="model"&&f.length>0&&(i=u.getXPath("instance"),s=f.add(u).index(u),e=e.replace(new RegExp(i,"g"),i+"["+(s+1)+"]"));return e},i.prototype.nsResolver={lookupNamespaceURI:function(e){var t={jr:"http://openrosa.org/javarosa",xsd:"http://www.w3.org/2001/XMLSchema",orx:"http://openrosa.org/xforms/",cc:"http://commcarehq.org/xforms"};return t[e]||null}},i.prototype.shiftRoot=function(e){return this.hasInstance&&(e=e.replace(/^(\/(?!model\/)[^\/][^\/\s]*\/)/g,"/model/instance[1]$1"),e=e.replace(/([^a-zA-Z0-9\.\]\)\/\*_-])(\/(?!model\/)[^\/][^\/\s]*\/)/g,"$1/model/instance[1]$2")),e},i.prototype.replaceInstanceFn=function(e){return e.replace(this.INSTANCE,function(e,t){return'/model/instance[@id="'+t+'"]'})},i.prototype.replaceCurrentFn=function(e){return e=e.replace(/current\(\)\/\./g,"."),e=e.replace(/current\(\)/g,""),e},i.prototype.replaceIndexedRepeatFn=function(e,n,r){var i=this,s=t.parseFunctionFromExpression(e,"indexed-repeat");return s.length?(s.forEach(function(t){var s,o,u,a=t[1].split(",");if(a.length%2!==1)return console.error("indexed repeat with incorrect number of parameters found",t[0]),'"Error with indexed-repeat parameters"';a=a.map(function(e){return e.trim()}),o=a[0];for(s=a.length-1;s>1;s-=2)u=isNaN(a[s])?i.evaluate(a[s],"number",n,r,!0):a[s],o=o.replace(a[s-1],a[s-1]+"[position() = "+u+"]");e=e.replace(t[0],o)}),e):e},i.prototype.evaluate=function(e,t,r,i,s){var o,u,a,f,l,c,h,p,d,v,m;s=s||!1,t=t||"any",i=i||0,f=this.xml,v=null,r?(p=this.node(r).get(),v=p.length,a=p.eq(i)[0]):a=this.rootElement,m=[e,r,i,v].join("|"),this.convertedExpressions[m]?e=this.convertedExpressions[m]:(e=e,e=e.trim(),e=this.shiftRoot(e),e=this.replaceInstanceFn(e),e=this.replaceCurrentFn(e),e=this.replaceIndexedRepeatFn(e,r,i),v&&v>1&&(e=this.makeBugCompliant(e,r,i)),e=e.replace(/&lt;/g,"<"),e=e.replace(/&gt;/g,">"),e=e.replace(/&quot;/g,'"'),this.convertedExpressions[m]=e),c={0:["any","ANY_TYPE"],1:["number","NUMBER_TYPE","numberValue"],2:["string","STRING_TYPE","stringValue"],3:["boolean","BOOLEAN_TYPE","booleanValue"],7:["nodes","ORDERED_NODE_SNAPSHOT_TYPE"],9:["node","FIRST_ORDERED_NODE_TYPE","singleNodeValue"]};for(l in c)if(c.hasOwnProperty(l)){l=Number(l);if(c[l][0]===t)break;l=0}if(s&&typeof f.evaluate!="undefined"&&!this.OPENROSA.test(e))try{h=f.evaluate(e,a,this.nsResolver,l,null)}catch(g){console.log("%cWell native XPath evaluation did not work... No worries, worth a shot, the expression probably contained unknown OpenRosa functions or errors:","color:orange",e)}if(!h)try{typeof f.jsEvaluate=="undefined"&&this.bindJsEvaluator(),h=f.jsEvaluate(e,a,this.nsResolver,l,null)}catch(g){return u="Error occurred trying to evaluate: "+e+", message: "+g.message,console.error(u),n(document).trigger("xpatherror",u),this.loadErrors.push(u),null}if(h){if(l===0){for(l in c)if(c.hasOwnProperty(l)){l=Number(l);if(l===Number(h.resultType)&&l>0&&l<4){d=h[c[l][2]];break}}console.error("Expression: "+e+" did not return any boolean, string or number value as expected")}else if(l===7){d=[];for(o=0;o<h.snapshotLength;o++)d.push(h.snapshotItem(o))}else d=h[c[l][2]];return d}},s=function(e,t,n,r){var i=r.hasInstance?"/model/instance[1]//*":"//*";this.model=r,this.originalSelector=e,this.selector=typeof e=="string"&&e.length>0?e:i,n=typeof n!="undefined"&&n!==null?n:{},this.filter=n,this.filter.onlyLeaf=typeof n.onlyLeaf!="undefined"?n.onlyLeaf:!1,this.filter.noEmpty=typeof n.noEmpty!="undefined"?n.noEmpty:!1,this.index=t},s.prototype.get=function(){var e,t;return this.nodes||(this.nodes=this.model.evaluate(this.selector,"nodes",null,null,!0)),this.filter.noEmpty===!0?e=n(this.nodes).filter(function(){var e=n(this);return t=e.text(),e.children().length===0&&t.trim().length>0}):this.filter.onlyLeaf===!0?e=n(this.nodes).filter(function(){return n(this).children().length===0}):e=n(this.nodes),typeof this.index!="undefined"&&this.index!==null?e.eq(this.index):e},s.prototype.setIndex=function(e){this.index=e},s.prototype.setVal=function(e,t,r){var i,s,o,u,a;return s=this.getVal()[0],typeof e!="undefined"&&e!==null?o=n.isArray(e)?e.join(" "):e.toString():o="",o=this.convert(o,r),i=this.get(),i.length===1&&n.trim(o.toString())!==n.trim(s.toString())?(i.text(o),u=this.validate(t,r),a=this.getClosestRepeat(),a.nodes=[i.prop("nodeName")],this.model.$.trigger("dataupdate",a),r==="binary"&&(o.length>0?i.attr("type","file"):i.removeAttr("type")),u):i.length>1?(console.error("nodeset.setVal expected nodeset with one node, but received multiple"),null):i.length===0?(console.error("Data node: "+this.selector+" with null-based index: "+this.index+" not found. Ignored."),null):null},s.prototype.getVal=function(){var e=[];return this.get().each(function(){e.push(n(this).text())}),e},s.prototype.determineIndex=function(e){var t,r,i;return e=e||this.get(),e.length===1?(t=e.prop("nodeName"),r=e.getXPath("instance"),i=this.model.$.find(t).filter(function(){return r===n(this).getXPath("instance")}),i.length===1?null:i.index(e)):(console.error("no node, or multiple nodes, provided to nodeset.determineIndex"),-1)},s.prototype.getClosestRepeat=function(){var e=this.get(),t=e.prop("nodeName");while(e.siblings(t).length===0&&t!=="instance")e=e.parent(),t=e.prop("nodeName");return t==="instance"?{}:{repeatPath:e.getXPath("instance"),repeatIndex:this.determineIndex(e)}},s.prototype.remove=function(){var e,t,r,i,s;e=this.get(),e.length>0?(t=[e.prop("nodeName")],e.find("*").each(function(){r=n(this),t.push(r.prop("nodeName"))}),i=e.getXPath("instance"),s=this.determineIndex(e),e.remove(),this.nodes=null,this.model.$.trigger("dataupdate",{updatedNodes:t,repeatPath:i,repeatIndex:s})):console.error("could not find node "+this.selector+" with index "+this.index+" to remove ")},s.prototype.convert=function(e,t){return e.toString()===""?e:typeof t!="undefined"&&t!==null&&typeof o[t.toLowerCase()]!="undefined"&&typeof o[t.toLowerCase()].convert!="undefined"?o[t.toLowerCase()].convert(e):e},s.prototype.validate=function(e,t){var n,r,i;if(!t||typeof o[t.toLowerCase()]=="undefined")t="string";return!!e||t!=="string"&&t!=="select"&&t!=="select1"&&t!=="binary"?(i=this.getVal()[0],i.toString()===""?!0:(n=o[t.toLowerCase()].validate(i),r=typeof e!="undefined"&&e!==null&&e.length>0?this.model.evaluate(e,"boolean",this.originalSelector,this.index):!0,n&&r)):!0},o={string:{validate:function(){return!0}},select:{validate:function(){return!0}},select1:{validate:function(){return!0}},decimal:{validate:function(e){return!isNaN(e-0)&&e!==null?!0:!1},convert:function(e){return e==="NaN"?"":e}},"int":{validate:function(e){return!isNaN(e-0)&&e!==null&&Math.round(e).toString()===e.toString()?!0:!1},convert:function(e){return e==="NaN"?"":e}},date:{validate:function(e){var t=/([0-9]{4})([\-]|[\/])([0-9]{2})([\-]|[\/])([0-9]{2})/,n=t.exec(e);return n&&n.length===6?(new Date(Number(n[1]),Number(n[3])-1,Number(n[5]))).toString()!=="Invalid Date":!1},convert:function(e){var t=/([0-9]{4})([\-]|[\/])([0-9]{2})([\-]|[\/])([0-9]{2})/,n=t.exec(e),r=new Date(e);return(new Date(e)).toString()==="Invalid Date"&&n&&Number(n[1])>0&&Number(n[3])>=0&&Number(n[3])<12&&Number(n[5])<32&&(r=new Date(Number(n[1]),Number(n[3])-1,Number(n[5]))),r.getUTCFullYear().toString().pad(4)+"-"+(r.getUTCMonth()+1).toString().pad(2)+"-"+r.getUTCDate().toString().pad(2)}},datetime:{validate:function(e){return(new Date(e.toString())).toString()!=="Invalid Date"||(new Date(this.convert(e.toString()))).toString()!=="Invalid Date"},convert:function(e){var t,n=/([0-9]{4}\-[0-9]{2}\-[0-9]{2})([T]|[\s])([0-9]){2}:([0-9]){2}([0-9:.]*)(\+|\-)([0-9]{2}):([0-9]{2})$/,r=/([0-9]{4}\-[0-9]{2}\-[0-9]{2})([T]|[\s])([0-9]){2}:([0-9]){2}([0-9:.]*)(\+|\-)([0-9]{2})$/;return(new Date(e)).toString()!=="Invalid Date"&&n.test(e)?e:(new Date(e)).toString()==="Invalid Date"&&r.test(e)?e+":00":(t=new Date(e),t.toString()!=="Invalid Date"?t.toISOLocalString():t.toString())}},time:{validate:function(e){var t=new Date,n=e.toString().split(":");return n.length<2?!1:(n[2]=n[2]?Number(n[2].toString().split(".")[0]):0,n[0]<24&&n[0]>=0&&n[1]<60&&n[1]>=0&&n[2]<60&&n[2]>=0&&t.toString()!=="Invalid Date")},convert:function(e){var t=e.toString().split(":");return n.each(t,function(e,n){t[e]=n.toString().pad(2)}),t.join(":")}},barcode:{validate:function(){return!0}},geopoint:{validate:function(e){var t=e.toString().trim().split(" ");return t[0]!==""&&t[0]>=-90&&t[0]<=90&&t[1]!==""&&t[1]>=-180&&t[1]<=180&&(typeof t[2]=="undefined"||!isNaN(t[2]))&&(typeof t[3]=="undefined"||!isNaN(t[3])&&t[3]>=0)},convert:function(e){return n.trim(e.toString())}},geotrace:{validate:function(e){var t=e.toString().split(";");return t.length>=2&&t.every(function(e){return o.geopoint.validate(e)})},convert:function(e){return e.toString().trim()}},geoshape:{validate:function(e){console.debug("validating geoshape, this: ",this);var t=e.toString().split(";");return t.length>=4&&t[0]===t[t.length-1]&&t.every(function(e){return o.geopoint.validate(e)})},convert:function(e){return e.toString().trim()}},binary:{validate:function(){return!0}}},i}),define("text",["module"],function(e){"use strict";var t,n,r,i,s,o=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],u=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,a=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,f=typeof location!="undefined"&&location.href,l=f&&location.protocol&&location.protocol.replace(/\:/,""),c=f&&location.hostname,h=f&&(location.port||undefined),p={},d=e.config&&e.config()||{};t={version:"2.0.10",strip:function(e){if(e){e=e.replace(u,"");var t=e.match(a);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:d.createXhr||function(){var e,t,n;if(typeof XMLHttpRequest!="undefined")return new XMLHttpRequest;if(typeof ActiveXObject!="undefined")for(t=0;t<3;t+=1){n=o[t];try{e=new ActiveXObject(n)}catch(r){}if(e){o=[n];break}}return e},parseName:function(e){var t,n,r,i=!1,s=e.indexOf("."),o=e.indexOf("./")===0||e.indexOf("../")===0;return s!==-1&&(!o||s>1)?(t=e.substring(0,s),n=e.substring(s+1,e.length)):t=e,r=n||t,s=r.indexOf("!"),s!==-1&&(i=r.substring(s+1)==="strip",r=r.substring(0,s),n?n=r:t=r),{moduleName:t,ext:n,strip:i}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,n,r,i){var s,o,u,a=t.xdRegExp.exec(e);return a?(s=a[2],o=a[3],o=o.split(":"),u=o[1],o=o[0],(!s||s===n)&&(!o||o.toLowerCase()===r.toLowerCase())&&(!u&&!o||u===i)):!0},finishLoad:function(e,n,r,i){r=n?t.strip(r):r,d.isBuild&&(p[e]=r),i(r)},load:function(e,n,r,i){if(i.isBuild&&!i.inlineText){r();return}d.isBuild=i.isBuild;var s=t.parseName(e),o=s.moduleName+(s.ext?"."+s.ext:""),u=n.toUrl(o),a=d.useXhr||t.useXhr;if(u.indexOf("empty:")===0){r();return}!f||a(u,l,c,h)?t.get(u,function(n){t.finishLoad(e,s.strip,n,r)},function(e){r.error&&r.error(e)}):n([o],function(e){t.finishLoad(s.moduleName+"."+s.ext,s.strip,e,r)})},write:function(e,n,r,i){if(p.hasOwnProperty(n)){var s=t.jsEscape(p[n]);r.asModule(e+"!"+n,"define(function () { return '"+s+"';});\n")}},writeFile:function(e,n,r,i,s){var o=t.parseName(n),u=o.ext?"."+o.ext:"",a=o.moduleName+u,f=r.toUrl(o.moduleName+u)+".js";t.load(a,r,function(n){var r=function(e){return i(f,e)};r.asModule=function(e,t){return i.asModule(e,f,t)},t.write(e,a,r,s)},s)}};if(d.env==="node"||!d.env&&typeof process!="undefined"&&process.versions&&!!process.versions.node&&!process.versions["node-webkit"])n=require.nodeRequire("fs"),t.get=function(e,t,r){try{var i=n.readFileSync(e,"utf8");i.indexOf("﻿")===0&&(i=i.substring(1)),t(i)}catch(s){r(s)}};else if(d.env==="xhr"||!d.env&&t.createXhr())t.get=function(e,n,r,i){var s=t.createXhr(),o;s.open("GET",e,!0);if(i)for(o in i)i.hasOwnProperty(o)&&s.setRequestHeader(o.toLowerCase(),i[o]);d.onXhr&&d.onXhr(s,e),s.onreadystatechange=function(t){var i,o;s.readyState===4&&(i=s.status,i>399&&i<600?(o=new Error(e+" HTTP status: "+i),o.xhr=s,r(o)):n(s.responseText),d.onXhrComplete&&d.onXhrComplete(s,e))},s.send(null)};else if(d.env==="rhino"||!d.env&&typeof Packages!="undefined"&&typeof java!="undefined")t.get=function(e,t){var n,r,i="utf-8",s=new java.io.File(e),o=java.lang.System.getProperty("line.separator"),u=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(s),i)),a="";try{n=new java.lang.StringBuffer,r=u.readLine(),r&&r.length()&&r.charAt(0)===65279&&(r=r.substring(1)),r!==null&&n.append(r);while((r=u.readLine())!==null)n.append(o),n.append(r);a=String(n.toString())}finally{u.close()}t(a)};else if(d.env==="xpconnect"||!d.env&&typeof Components!="undefined"&&Components.classes&&Components.interfaces)r=Components.classes,i=Components.interfaces,Components.utils["import"]("resource://gre/modules/FileUtils.jsm"),s="@mozilla.org/windows-registry-key;1"in r,t.get=function(e,t){var n,o,u,a={};s&&(e=e.replace(/\//g,"\\")),u=new FileUtils.File(e);try{n=r["@mozilla.org/network/file-input-stream;1"].createInstance(i.nsIFileInputStream),n.init(u,1,0,!1),o=r["@mozilla.org/intl/converter-input-stream;1"].createInstance(i.nsIConverterInputStream),o.init(n,"utf-8",n.available(),i.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),o.readString(n.available(),a),o.close(),n.close(),t(a.value)}catch(f){throw new Error((u&&u.path||"")+": "+f)}};return t}),define("text!enketo-config",[],function(){return'{\n    "widgets": [\n        "enketo-widget/note/notewidget",\n        "enketo-widget/select-desktop/selectpicker",\n        "enketo-widget/select-mobile/selectpicker",\n        "enketo-widget/geo/geopicker",\n        "enketo-widget/table/tablewidget",\n        "enketo-widget/radio/radiopicker",\n        "enketo-widget/date/datepicker-extended",\n        "enketo-widget/time/timepicker-extended",\n        "enketo-widget/datetime/datetimepicker-extended",\n        "enketo-widget/mediagrid/mediagridpicker",\n        "enketo-widget/file/filepicker",\n        "enketo-widget/select-likert/likertitem",\n        "enketo-widget/distress/distresspicker",\n        "enketo-widget/horizontal-choices/horizontalchoices"\n    ],\n    "maps": [ {\n        "tiles": [ "http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" ],\n        "name": "streets",\n        "attribution": "Map data © <a href=\\"http://openstreetmap.org\\">OpenStreetMap</a> contributors"\n    }, {\n        "tiles": "GOOGLE_SATELLITE",\n        "name": "satellite"\n    } ],\n    "googleApiKey": ""\n}\n'}),define("enketo-js/support",[],function(){var e={inputtypes:{}},t=["date","datetime","time"];return t.forEach(function(t){var n=document.createElement("input");n.setAttribute("type",t),e.inputtypes[t]=n.type!=="text"}),"ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch?(e.touch=!0,document.documentElement.classList+=" touch"):e.touch=!1,e}),function(e){if(typeof bootstrap=="function")bootstrap("promise",e);else if(typeof exports=="object")module.exports=e();else if(typeof define=="function"&&define.amd)define("q",e);else if(typeof ses!="undefined"){if(!ses.ok())return;ses.makeQ=e}else Q=e()}(function(){"use strict";function u(e){return function(){return o.apply(e,arguments)}}function m(e){return e===Object(e)}function g(e){return v(e)==="[object StopIteration]"||e instanceof y}function w(t,n){if(e&&n.stack&&typeof t=="object"&&t!==null&&t.stack&&t.stack.indexOf(b)===-1){var r=[];for(var i=n;!!i;i=i.source)i.stack&&r.unshift(i.stack);r.unshift(t.stack);var s=r.join("\n"+b+"\n");t.stack=E(s)}}function E(e){var t=e.split("\n"),n=[];for(var r=0;r<t.length;++r){var i=t[r];!T(i)&&!S(i)&&i&&n.push(i)}return n.join("\n")}function S(e){return e.indexOf("(module.js:")!==-1||e.indexOf("(node.js:")!==-1}function x(e){var t=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(e);if(t)return[t[1],Number(t[2])];var n=/at ([^ ]+):(\d+):(?:\d+)$/.exec(e);if(n)return[n[1],Number(n[2])];var r=/.*@(.+):(\d+)$/.exec(e);if(r)return[r[1],Number(r[2])]}function T(e){var t=x(e);if(!t)return!1;var i=t[0],s=t[1];return i===r&&s>=n&&s<=ot}function N(){if(!e)return;try{throw new Error}catch(t){var n=t.stack.split("\n"),i=n[0].indexOf("@")>0?n[1]:n[2],s=x(i);if(!s)return;return r=s[0],s[1]}}function C(e,t,n){return function(){return typeof console!="undefined"&&typeof console.warn=="function"&&console.warn(t+" is deprecated, use "+n+" instead.",(new Error("")).stack),e.apply(e,arguments)}}function k(e){return P(e)?e:H(e)?$(e):V(e)}function L(){function l(e){r=e,o.source=e,f(t,function(t,n){s(function(){e.promiseDispatch.apply(e,n)})},void 0),t=void 0,n=void 0}var t=[],n=[],r,i=h(L.prototype),o=h(M.prototype);o.promiseDispatch=function(e,i,o){var u=a(arguments);t?(t.push(u),i==="when"&&o[1]&&n.push(o[1])):s(function(){r.promiseDispatch.apply(r,u)})},o.valueOf=function(){if(t)return o;var e=D(r);return P(e)&&(r=e),e},o.inspect=function(){return r?r.inspect():{state:"pending"}};if(k.longStackSupport&&e)try{throw new Error}catch(u){o.stack=u.stack.substring(u.stack.indexOf("\n")+1)}return i.promise=o,i.resolve=function(e){if(r)return;l(k(e))},i.fulfill=function(e){if(r)return;l(V(e))},i.reject=function(e){if(r)return;l(X(e))},i.notify=function(e){if(r)return;f(n,function(t,n){s(function(){n(e)})},void 0)},i}function A(e){if(typeof e!="function")throw new TypeError("resolver must be a function.");var t=L();try{e(t.resolve,t.reject,t.notify)}catch(n){t.reject(n)}return t.promise}function O(e){return A(function(t,n){for(var r=0,i=e.length;r<i;r++)k(e[r]).then(t,n)})}function M(e,t,n){t===void 0&&(t=function(e){return X(new Error("Promise does not support operation: "+e))}),n===void 0&&(n=function(){return{state:"unknown"}});var r=h(M.prototype);r.promiseDispatch=function(n,i,s){var o;try{e[i]?o=e[i].apply(r,s):o=t.call(r,i,s)}catch(u){o=X(u)}n&&n(o)},r.inspect=n;if(n){var i=n();i.state==="rejected"&&(r.exception=i.reason),r.valueOf=function(){var e=n();return e.state==="pending"||e.state==="rejected"?r:e.value}}return r}function _(e,t,n,r){return k(e).then(t,n,r)}function D(e){if(P(e)){var t=e.inspect();if(t.state==="fulfilled")return t.value}return e}function P(e){return m(e)&&typeof e.promiseDispatch=="function"&&typeof e.inspect=="function"}function H(e){return m(e)&&typeof e.then=="function"}function B(e){return P(e)&&e.inspect().state==="pending"}function j(e){return!P(e)||e.inspect().state==="fulfilled"}function F(e){return P(e)&&e.inspect().state==="rejected"}function U(){I.length=0,q.length=0,R||(R=!0)}function z(e,t){if(!R)return;q.push(e),t&&typeof t.stack!="undefined"?I.push(t.stack):I.push("(no stack) "+t)}function W(e){if(!R)return;var t=l(q,e);t!==-1&&(q.splice(t,1),I.splice(t,1))}function X(e){var t=M({when:function(t){return t&&W(this),t?t(e):this}},function(){return this},function(){return{state:"rejected",reason:e}});return z(t,e),t}function V(e){return M({when:function(){return e},get:function(t){return e[t]},set:function(t,n){e[t]=n},"delete":function(t){delete e[t]},post:function(t,n){return t===null||t===void 0?e.apply(void 0,n):e[t].apply(e,n)},apply:function(t,n){return e.apply(t,n)},keys:function(){return d(e)}},void 0,function(){return{state:"fulfilled",value:e}})}function $(e){var t=L();return s(function(){try{e.then(t.resolve,t.reject,t.notify)}catch(n){t.reject(n)}}),t.promise}function J(e){return M({isDef:function(){}},function(n,r){return et(e,n,r)},function(){return k(e).inspect()})}function K(e,t,n){return k(e).spread(t,n)}function Q(e){return function(){function t(e,t){var s;if(typeof StopIteration=="undefined"){try{s=n[e](t)}catch(o){return X(o)}return s.done?s.value:_(s.value,r,i)}try{s=n[e](t)}catch(o){return g(o)?o.value:X(o)}return _(s,r,i)}var n=e.apply(this,arguments),r=t.bind(t,"next"),i=t.bind(t,"throw");return r()}}function G(e){k.done(k.async(e)())}function Y(e){throw new y(e)}function Z(e){return function(){return K([this,tt(arguments)],function(t,n){return e.apply(t,n)})}}function et(e,t,n){return k(e).dispatch(t,n)}function tt(e){return _(e,function(e){var t=0,n=L();return f(e,function(r,i,s){var o;P(i)&&(o=i.inspect()).state==="fulfilled"?e[s]=o.value:(++t,_(i,function(r){e[s]=r,--t===0&&n.resolve(e)},n.reject,function(e){n.notify({index:s,value:e})}))},void 0),t===0&&n.resolve(e),n.promise})}function nt(e){return _(e,function(e){return e=c(e,k),_(tt(c(e,function(e){return _(e,i,i)})),function(){return e})})}function rt(e){return k(e).allSettled()}function it(e,t){return k(e).then(void 0,void 0,t)}function st(e,t){return k(e).nodeify(t)}var e=!1;try{throw new Error}catch(t){e=!!t.stack}var n=N(),r,i=function(){},s=function(){function o(){while(e.next){e=e.next;var t=e.task;e.task=void 0;var r=e.domain;r&&(e.domain=void 0,r.enter());try{t()}catch(s){if(i)throw r&&r.exit(),setTimeout(o,0),r&&r.enter(),s;setTimeout(function(){throw s},0)}r&&r.exit()}n=!1}var e={task:void 0,next:null},t=e,n=!1,r=void 0,i=!1;s=function(e){t=t.next={task:e,domain:i&&process.domain,next:null},n||(n=!0,r())};if(typeof process!="undefined"&&process.nextTick)i=!0,r=function(){process.nextTick(o)};else if(typeof setImmediate=="function")typeof window!="undefined"?r=setImmediate.bind(window,o):r=function(){setImmediate(o)};else if(typeof MessageChannel!="undefined"){var u=new MessageChannel;u.port1.onmessage=function(){r=a,u.port1.onmessage=o,o()};var a=function(){u.port2.postMessage(0)};r=function(){setTimeout(o,0),a()}}else r=function(){setTimeout(o,0)};return s}(),o=Function.call,a=u(Array.prototype.slice),f=u(Array.prototype.reduce||function(e,t){var n=0,r=this.length;if(arguments.length===1)do{if(n in this){t=this[n++];break}if(++n>=r)throw new TypeError}while(1);for(;n<r;n++)n in this&&(t=e(t,this[n],n));return t}),l=u(Array.prototype.indexOf||function(e){for(var t=0;t<this.length;t++)if(this[t]===e)return t;return-1}),c=u(Array.prototype.map||function(e,t){var n=this,r=[];return f(n,function(i,s,o){r.push(e.call(t,s,o,n))},void 0),r}),h=Object.create||function(e){function t(){}return t.prototype=e,new t},p=u(Object.prototype.hasOwnProperty),d=Object.keys||function(e){var t=[];for(var n in e)p(e,n)&&t.push(n);return t},v=u(Object.prototype.toString),y;typeof ReturnValue!="undefined"?y=ReturnValue:y=function(e){this.value=e};var b="From previous event:";k.resolve=k,k.nextTick=s,k.longStackSupport=!1,k.defer=L,L.prototype.makeNodeResolver=function(){var e=this;return function(t,n){t?e.reject(t):arguments.length>2?e.resolve(a(arguments,1)):e.resolve(n)}},k.Promise=A,k.promise=A,A.race=O,A.all=tt,A.reject=X,A.resolve=k,k.passByCopy=function(e){return e},M.prototype.passByCopy=function(){return this},k.join=function(e,t){return k(e).join(t)},M.prototype.join=function(e){return k([this,e]).spread(function(e,t){if(e===t)return e;throw new Error("Can't join: not the same: "+e+" "+t)})},k.race=O,M.prototype.race=function(){return this.then(k.race)},k.makePromise=M,M.prototype.toString=function(){return"[object Promise]"},M.prototype.then=function(e,t,n){function u(t){try{return typeof e=="function"?e(t):t}catch(n){return X(n)}}function a(e){if(typeof t=="function"){w(e,r);try{return t(e)}catch(n){return X(n)}}return X(e)}function f(e){return typeof n=="function"?n(e):e}var r=this,i=L(),o=!1;return s(function(){r.promiseDispatch(function(e){if(o)return;o=!0,i.resolve(u(e))},"when",[function(e){if(o)return;o=!0,i.resolve(a(e))}])}),r.promiseDispatch(void 0,"when",[void 0,function(e){var t,n=!1;try{t=f(e)}catch(r){n=!0;if(!k.onerror)throw r;k.onerror(r)}n||i.notify(t)}]),i.promise},k.when=_,M.prototype.thenResolve=function(e){return this.then(function(){return e})},k.thenResolve=function(e,t){return k(e).thenResolve(t)},M.prototype.thenReject=function(e){return this.then(function(){throw e})},k.thenReject=function(e,t){return k(e).thenReject(t)},k.nearer=D,k.isPromise=P,k.isPromiseAlike=H,k.isPending=B,M.prototype.isPending=function(){return this.inspect().state==="pending"},k.isFulfilled=j,M.prototype.isFulfilled=function(){return this.inspect().state==="fulfilled"},k.isRejected=F,M.prototype.isRejected=function(){return this.inspect().state==="rejected"};var I=[],q=[],R=!0;k.resetUnhandledRejections=U,k.getUnhandledReasons=function(){return I.slice()},k.stopUnhandledRejectionTracking=function(){U(),R=!1},U(),k.reject=X,k.fulfill=V,k.master=J,k.spread=K,M.prototype.spread=function(e,t){return this.all().then(function(t){return e.apply(void 0,t)},t)},k.async=Q,k.spawn=G,k["return"]=Y,k.promised=Z,k.dispatch=et,M.prototype.dispatch=function(e,t){var n=this,r=L();return s(function(){n.promiseDispatch(r.resolve,e,t)}),r.promise},k.get=function(e,t){return k(e).dispatch("get",[t])},M.prototype.get=function(e){return this.dispatch("get",[e])},k.set=function(e,t,n){return k(e).dispatch("set",[t,n])},M.prototype.set=function(e,t){return this.dispatch("set",[e,t])},k.del=k["delete"]=function(e,t){return k(e).dispatch("delete",[t])},M.prototype.del=M.prototype["delete"]=function(e){return this.dispatch("delete",[e])},k.mapply=k.post=function(e,t,n){return k(e).dispatch("post",[t,n])},M.prototype.mapply=M.prototype.post=function(e,t){return this.dispatch("post",[e,t])},k.send=k.mcall=k.invoke=function(e,t){return k(e).dispatch("post",[t,a(arguments,2)])},M.prototype.send=M.prototype.mcall=M.prototype.invoke=function(e){return this.dispatch("post",[e,a(arguments,1)])},k.fapply=function(e,t){return k(e).dispatch("apply",[void 0,t])},M.prototype.fapply=function(e){return this.dispatch("apply",[void 0,e])},k["try"]=k.fcall=function(e){return k(e).dispatch("apply",[void 0,a(arguments,1)])},M.prototype.fcall=function(){return this.dispatch("apply",[void 0,a(arguments)])},k.fbind=function(e){var t=k(e),n=a(arguments,1);return function(){return t.dispatch("apply",[this,n.concat(a(arguments))])}},M.prototype.fbind=function(){var e=this,t=a(arguments);return function(){return e.dispatch("apply",[this,t.concat(a(arguments))])}},k.keys=function(e){return k(e).dispatch("keys",[])},M.prototype.keys=function(){return this.dispatch("keys",[])},k.all=tt,M.prototype.all=function(){return tt(this)},k.allResolved=C(nt,"allResolved","allSettled"),M.prototype.allResolved=function(){return nt(this)},k.allSettled=rt,M.prototype.allSettled=function(){return this.then(function(e){return tt(c(e,function(e){function t(){return e.inspect()}return e=k(e),e.then(t,t)}))})},k.fail=k["catch"]=function(e,t){return k(e).then(void 0,t)},M.prototype.fail=M.prototype["catch"]=function(e){return this.then(void 0,e)},k.progress=it,M.prototype.progress=function(e){return this.then(void 0,void 0,e)},k.fin=k["finally"]=function(e,t){return k(e)["finally"](t)},M.prototype.fin=M.prototype["finally"]=function(e){return e=k(e),this.then(function(t){return e.fcall().then(function(){return t})},function(t){return e.fcall().then(function(){throw t})})},k.done=function(e,t,n,r){return k(e).done(t,n,r)},M.prototype.done=function(e,t,n){var r=function(e){s(function(){w(e,i);if(!k.onerror)throw e;k.onerror(e)})},i=e||t||n?this.then(e,t,n):this;typeof process=="object"&&process&&process.domain&&(r=process.domain.bind(r)),i.then(void 0,r)},k.timeout=function(e,t,n){return k(e).timeout(t,n)},M.prototype.timeout=function(e,t){var n=L(),r=setTimeout(function(){n.reject(new Error(t||"Timed out after "+e+" ms"))},e);return this.then(function(e){clearTimeout(r),n.resolve(e)},function(e){clearTimeout(r),n.reject(e)},n.notify),n.promise},k.delay=function(e,t){return t===void 0&&(t=e,e=void 0),k(e).delay(t)},M.prototype.delay=function(e){return this.then(function(t){var n=L();return setTimeout(function(){n.resolve(t)},e),n.promise})},k.nfapply=function(e,t){return k(e).nfapply(t)},M.prototype.nfapply=function(e){var t=L(),n=a(e);return n.push(t.makeNodeResolver()),this.fapply(n).fail(t.reject),t.promise},k.nfcall=function(e){var t=a(arguments,1);return k(e).nfapply(t)},M.prototype.nfcall=function(){var e=a(arguments),t=L();return e.push(t.makeNodeResolver()),this.fapply(e).fail(t.reject),t.promise},k.nfbind=k.denodeify=function(e){var t=a(arguments,1);return function(){var n=t.concat(a(arguments)),r=L();return n.push(r.makeNodeResolver()),k(e).fapply(n).fail(r.reject),r.promise}},M.prototype.nfbind=M.prototype.denodeify=function(){var e=a(arguments);return e.unshift(this),k.denodeify.apply(void 0,e)},k.nbind=function(e,t){var n=a(arguments,2);return function(){function s(){return e.apply(t,arguments)}var r=n.concat(a(arguments)),i=L();return r.push(i.makeNodeResolver()),k(s).fapply(r).fail(i.reject),i.promise}},M.prototype.nbind=function(){var e=a(arguments,0);return e.unshift(this),k.nbind.apply(void 0,e)},k.nmapply=k.npost=function(e,t,n){return k(e).npost(t,n)},M.prototype.nmapply=M.prototype.npost=function(e,t){var n=a(t||[]),r=L();return n.push(r.makeNodeResolver()),this.dispatch("post",[e,n]).fail(r.reject),r.promise},k.nsend=k.nmcall=k.ninvoke=function(e,t){var n=a(arguments,2),r=L();return n.push(r.makeNodeResolver()),k(e).dispatch("post",[t,n]).fail(r.reject),r.promise},M.prototype.nsend=M.prototype.nmcall=M.prototype.ninvoke=function(e){var t=a(arguments,1),n=L();return t.push(n.makeNodeResolver()),this.dispatch("post",[e,t]).fail(n.reject),n.promise},k.nodeify=st,M.prototype.nodeify=function(e){if(!e)return this;this.then(function(t){s(function(){e(null,t)})},function(t){s(function(){e(t)})})};var ot=N();return k}),define("enketo-js/widgets",["text!enketo-config","enketo-js/support","q","jquery"],function(e,t,n,r){"use strict";var i,s,o,u,a,f,l,c,h,p,d,v=[];return s=function(t){i=r("form.or"),t=t||i,f(JSON.parse(e)).then(function(e){c(t)})},o=function(e){var t,n;for(var r=0;r<v.length;r++)t=v[r],t.name&&(n=l(e,t.selector),n[t.name]("enable"))},u=function(e){var t,n;for(var r=0;r<v.length;r++)t=v[r],t.name&&(n=l(e,t.selector),n[t.name]("disable"))},a=function(e){var t,n;for(var r=0;r<v.length;r++)t=v[r],t.name&&(n=l(e,t.selector),n[t.name]("destroy"))},f=function(e){var t,r,i=n.defer(),s=[];for(var o=0;o<e.widgets.length;o++)t="text!"+e.widgets[o].substr(0,e.widgets[o].lastIndexOf("/")+1)+"config.json",s.push(t);return require(s,function(){for(var t=0;t<arguments.length;t++)r=JSON.parse(arguments[t]),r.path=e.widgets[t],v.push(r);i.resolve(v)}),i.promise},l=function(e,t){return t?t==="form"?i:e.find(t):r()},c=function(e){v.forEach(function(n){var r;n.options=n.options||{},n.options.touch=t.touch;if(!n.selector&&n.selector!==null)return console.error("widget configuration has no acceptable selector property",n);r=l(e,n.selector);if(!r.length)return;n.load||(n.load=h(n)),n.load.then(function(e){e.name&&(r[e.name](e.options),p(e,r),d(e,r))})})},h=function(e){var t=n.defer();return require([e.path],function(n){e.name=n,t.resolve(e)}),t.promise},p=function(e,t){t.length>0&&i.on("changelanguage",function(){t[e.name]("update")})},d=function(e,t){t.length>0&&t.prop("nodeName").toLowerCase()==="select"&&i.on("changeoption","select",function(){r(this)[e.name]("update")})},{init:s,enable:o,disable:u,destroy:a}}),function(e){typeof define=="function"&&define.amd&&define.amd.jQuery?define("jquery.touchswipe",["jquery"],e):e(jQuery)}(function(e){"use strict";function N(t){return t&&t.allowPageScroll===undefined&&(t.swipe!==undefined||t.swipeStatus!==undefined)&&(t.allowPageScroll=u),t.click!==undefined&&t.tap===undefined&&(t.tap=t.click),t||(t={}),t=e.extend({},e.fn.swipe.defaults,t),this.each(function(){var n=e(this),r=n.data(x);r||(r=new C(this,t),n.data(x,r))})}function C(T,N){function Z(t){if(Pt())return;if(e(t.target).closest(N.excludedElements,R).length>0)return;var n=t.originalEvent?t.originalEvent:t,r,i=S?n.touches[0]:n;U=y,S?z=n.touches.length:t.preventDefault(),_=0,D=null,I=null,P=0,H=0,B=0,j=1,F=0,W=It(),q=Ut(),_t();if(!S||z===N.fingers||N.fingers===m||dt()){Bt(0,i),X=Gt(),z==2&&(Bt(1,n.touches[1]),H=B=Xt(W[0].start,W[1].start));if(N.swipeStatus||N.pinchStatus)r=ot(n,U)}else r=!1;return r===!1?(U=E,ot(n,U),r):(Ht(!0),null)}function et(e){var t=e.originalEvent?e.originalEvent:e;if(U===w||U===E||Dt())return;var n,r=S?t.touches[0]:t,i=jt(r);V=Gt(),S&&(z=t.touches.length),U=b,z==2&&(H==0?(Bt(1,t.touches[1]),H=B=Xt(W[0].start,W[1].start)):(jt(t.touches[1]),B=Xt(W[0].end,W[1].end),I=$t(W[0].end,W[1].end)),j=Vt(H,B),F=Math.abs(H-B));if(z===N.fingers||N.fingers===m||!S||dt()){D=Qt(i.start,i.end),ht(e,D),_=Jt(i.start,i.end),P=Wt(),qt(D,_);if(N.swipeStatus||N.pinchStatus)n=ot(t,U);if(!N.triggerOnTouchEnd||N.triggerOnTouchLeave){var s=!0;if(N.triggerOnTouchLeave){var o=Yt(this);s=Zt(i.end,o)}!N.triggerOnTouchEnd&&s?U=st(b):N.triggerOnTouchLeave&&!s&&(U=st(w)),(U==E||U==w)&&ot(t,U)}}else U=E,ot(t,U);n===!1&&(U=E,ot(t,U))}function tt(e){var t=e.originalEvent;return S&&t.touches.length>0?(Mt(),!0):(Dt()&&(z=K),e.preventDefault(),V=Gt(),P=Wt(),ft()?(U=E,ot(t,U)):N.triggerOnTouchEnd||N.triggerOnTouchEnd==0&&U===b?(U=w,ot(t,U)):!N.triggerOnTouchEnd&&Et()?(U=w,ut(t,U,c)):U===b&&(U=E,ot(t,U)),Ht(!1),null)}function nt(){z=0,V=0,X=0,H=0,B=0,j=1,_t(),Ht(!1)}function rt(e){var t=e.originalEvent;N.triggerOnTouchLeave&&(U=st(w),ot(t,U))}function it(){R.unbind(k,Z),R.unbind(M,nt),R.unbind(L,et),R.unbind(A,tt),O&&R.unbind(O,rt),Ht(!1)}function st(e){var t=e,n=ct(),r=at(),i=ft();return!n||i?t=E:r&&e==b&&(!N.triggerOnTouchEnd||N.triggerOnTouchLeave)?t=w:!r&&e==w&&N.triggerOnTouchLeave&&(t=E),t}function ot(e,t){var n=undefined;return yt()||gt()?n=ut(e,t,f):(vt()||dt())&&n!==!1&&(n=ut(e,t,l)),At()&&n!==!1?n=ut(e,t,h):Ot()&&n!==!1?n=ut(e,t,p):Lt()&&n!==!1&&(n=ut(e,t,c)),t===E&&nt(e),t===w&&(S?e.touches.length==0&&nt(e):nt(e)),n}function ut(u,a,d){var v=undefined;if(d==f){R.trigger("swipeStatus",[a,D||null,_||0,P||0,z]);if(N.swipeStatus){v=N.swipeStatus.call(R,u,a,D||null,_||0,P||0,z);if(v===!1)return!1}if(a==w&&mt()){R.trigger("swipe",[D,_,P,z]);if(N.swipe){v=N.swipe.call(R,u,D,_,P,z);if(v===!1)return!1}switch(D){case t:R.trigger("swipeLeft",[D,_,P,z]),N.swipeLeft&&(v=N.swipeLeft.call(R,u,D,_,P,z));break;case n:R.trigger("swipeRight",[D,_,P,z]),N.swipeRight&&(v=N.swipeRight.call(R,u,D,_,P,z));break;case r:R.trigger("swipeUp",[D,_,P,z]),N.swipeUp&&(v=N.swipeUp.call(R,u,D,_,P,z));break;case i:R.trigger("swipeDown",[D,_,P,z]),N.swipeDown&&(v=N.swipeDown.call(R,u,D,_,P,z))}}}if(d==l){R.trigger("pinchStatus",[a,I||null,F||0,P||0,z,j]);if(N.pinchStatus){v=N.pinchStatus.call(R,u,a,I||null,F||0,P||0,z,j);if(v===!1)return!1}if(a==w&&pt())switch(I){case s:R.trigger("pinchIn",[I||null,F||0,P||0,z,j]),N.pinchIn&&(v=N.pinchIn.call(R,u,I||null,F||0,P||0,z,j));break;case o:R.trigger("pinchOut",[I||null,F||0,P||0,z,j]),N.pinchOut&&(v=N.pinchOut.call(R,u,I||null,F||0,P||0,z,j))}}if(d==c){if(a===E||a===w)clearTimeout(G),St()&&!Nt()?(Q=Gt(),G=setTimeout(e.proxy(function(){Q=null,R.trigger("tap",[u.target]),N.tap&&(v=N.tap.call(R,u,u.target))},this),N.doubleTapThreshold)):(Q=null,R.trigger("tap",[u.target]),N.tap&&(v=N.tap.call(R,u,u.target)))}else if(d==h){if(a===E||a===w)clearTimeout(G),Q=null,R.trigger("doubletap",[u.target]),N.doubleTap&&(v=N.doubleTap.call(R,u,u.target))}else d==p&&(a===E||a===w)&&(clearTimeout(G),Q=null,R.trigger("longtap",[u.target]),N.longTap&&(v=N.longTap.call(R,u,u.target)));return v}function at(){var e=!0;return N.threshold!==null&&(e=_>=N.threshold),e}function ft(){var e=!1;return N.cancelThreshold!==null&&D!==null&&(e=Rt(D)-_>=N.cancelThreshold),e}function lt(){return N.pinchThreshold!==null?F>=N.pinchThreshold:!0}function ct(){var e;return N.maxTimeThreshold?P>=N.maxTimeThreshold?e=!1:e=!0:e=!0,e}function ht(e,s){if(N.allowPageScroll===u||dt())e.preventDefault();else{var o=N.allowPageScroll===a;switch(s){case t:(N.swipeLeft&&o||!o&&N.allowPageScroll!=d)&&e.preventDefault();break;case n:(N.swipeRight&&o||!o&&N.allowPageScroll!=d)&&e.preventDefault();break;case r:(N.swipeUp&&o||!o&&N.allowPageScroll!=v)&&e.preventDefault();break;case i:(N.swipeDown&&o||!o&&N.allowPageScroll!=v)&&e.preventDefault()}}}function pt(){var e=bt(),t=wt(),n=lt();return e&&t&&n}function dt(){return!!(N.pinchStatus||N.pinchIn||N.pinchOut)}function vt(){return!!pt()&&!!dt()}function mt(){var e=ct(),t=at(),n=bt(),r=wt(),i=ft(),s=!i&&r&&n&&t&&e;return s}function gt(){return!!(N.swipe||N.swipeStatus||N.swipeLeft||N.swipeRight||N.swipeUp||N.swipeDown)}function yt(){return!!mt()&&!!gt()}function bt(){return z===N.fingers||N.fingers===m||!S}function wt(){return W[0].end.x!==0}function Et(){return!!N.tap}function St(){return!!N.doubleTap}function xt(){return!!N.longTap}function Tt(){if(Q==null)return!1;var e=Gt();return St()&&e-Q<=N.doubleTapThreshold}function Nt(){return Tt()}function Ct(){return(z===1||!S)&&(isNaN(_)||_===0)}function kt(){return P>N.longTapThreshold&&_<g}function Lt(){return!!Ct()&&!!Et()}function At(){return!!Tt()&&!!St()}function Ot(){return!!kt()&&!!xt()}function Mt(){J=Gt(),K=event.touches.length+1}function _t(){J=0,K=0}function Dt(){var e=!1;if(J){var t=Gt()-J;t<=N.fingerReleaseThreshold&&(e=!0)}return e}function Pt(){return R.data(x+"_intouch")===!0}function Ht(e){e===!0?(R.bind(L,et),R.bind(A,tt),O&&R.bind(O,rt)):(R.unbind(L,et,!1),R.unbind(A,tt,!1),O&&R.unbind(O,rt,!1)),R.data(x+"_intouch",e===!0)}function Bt(e,t){var n=t.identifier!==undefined?t.identifier:0;return W[e].identifier=n,W[e].start.x=W[e].end.x=t.pageX||t.clientX,W[e].start.y=W[e].end.y=t.pageY||t.clientY,W[e]}function jt(e){var t=e.identifier!==undefined?e.identifier:0,n=Ft(t);return n.end.x=e.pageX||e.clientX,n.end.y=e.pageY||e.clientY,n}function Ft(e){for(var t=0;t<W.length;t++)if(W[t].identifier==e)return W[t]}function It(){var e=[];for(var t=0;t<=5;t++)e.push({start:{x:0,y:0},end:{x:0,y:0},identifier:0});return e}function qt(e,t){t=Math.max(t,Rt(e)),q[e].distance=t}function Rt(e){return q[e]?q[e].distance:undefined}function Ut(){var e={};return e[t]=zt(t),e[n]=zt(n),e[r]=zt(r),e[i]=zt(i),e}function zt(e){return{direction:e,distance:0}}function Wt(){return V-X}function Xt(e,t){var n=Math.abs(e.x-t.x),r=Math.abs(e.y-t.y);return Math.round(Math.sqrt(n*n+r*r))}function Vt(e,t){var n=t/e*1;return n.toFixed(2)}function $t(){return j<1?o:s}function Jt(e,t){return Math.round(Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)))}function Kt(e,t){var n=e.x-t.x,r=t.y-e.y,i=Math.atan2(r,n),s=Math.round(i*180/Math.PI);return s<0&&(s=360-Math.abs(s)),s}function Qt(e,s){var o=Kt(e,s);return o<=45&&o>=0?t:o<=360&&o>=315?t:o>=135&&o<=225?n:o>45&&o<135?i:r}function Gt(){var e=new Date;return e.getTime()}function Yt(t){t=e(t);var n=t.offset(),r={left:n.left,right:n.left+t.outerWidth(),top:n.top,bottom:n.top+t.outerHeight()};return r}function Zt(e,t){return e.x>t.left&&e.x<t.right&&e.y>t.top&&e.y<t.bottom}var C=S||!N.fallbackToMouseEvents,k=C?"touchstart":"mousedown",L=C?"touchmove":"mousemove",A=C?"touchend":"mouseup",O=C?null:"mouseleave",M="touchcancel",_=0,D=null,P=0,H=0,B=0,j=1,F=0,I=0,q=null,R=e(T),U="start",z=0,W=null,X=0,V=0,J=0,K=0,Q=0,G=null;try{R.bind(k,Z),R.bind(M,nt)}catch(Y){e.error("events not supported "+k+","+M+" on jQuery.swipe")}this.enable=function(){return R.bind(k,Z),R.bind(M,nt),R},this.disable=function(){return it(),R},this.destroy=function(){return it(),R.data(x,null),R},this.option=function(t,n){if(N[t]!==undefined){if(n===undefined)return N[t];N[t]=n}else e.error("Option "+t+" does not exist on jQuery.swipe.options");return null}}var t="left",n="right",r="up",i="down",s="in",o="out",u="none",a="auto",f="swipe",l="pinch",c="tap",h="doubletap",p="longtap",d="horizontal",v="vertical",m="all",g=10,y="start",b="move",w="end",E="cancel",S="ontouchstart"in window,x="TouchSwipe",T={fingers:1,threshold:75,cancelThreshold:null,pinchThreshold:20,maxTimeThreshold:null,fingerReleaseThreshold:250,longTapThreshold:500,doubleTapThreshold:200,swipe:null,swipeLeft:null,swipeRight:null,swipeUp:null,swipeDown:null,swipeStatus:null,pinchIn:null,pinchOut:null,pinchStatus:null,click:null,tap:null,doubleTap:null,longTap:null,triggerOnTouchEnd:!0,triggerOnTouchLeave:!1,allowPageScroll:"auto",fallbackToMouseEvents:!0,excludedElements:"label, button, input, select, textarea, a, .noSwipe"};e.fn.swipe=function(t){var n=e(this),r=n.data(x);if(r&&typeof t=="string"){if(r[t])return r[t].apply(this,Array.prototype.slice.call(arguments,1));e.error("Method "+t+" does not exist on jQuery.swipe")}else if(!r&&(typeof t=="object"||!t))return N.apply(this,arguments);return n},e.fn.swipe.defaults=T,e.fn.swipe.phases={PHASE_START:y,PHASE_MOVE:b,PHASE_END:w,PHASE_CANCEL:E},e.fn.swipe.directions={LEFT:t,RIGHT:n,UP:r,DOWN:i,IN:s,OUT:o},e.fn.swipe.pageScroll={NONE:u,HORIZONTAL:d,VERTICAL:v,AUTO:a},e.fn.swipe.fingers={ONE:1,TWO:2,THREE:3,ALL:m}}),define("enketo-js/Form",["enketo-js/FormModel","enketo-js/widgets","jquery","enketo-js/plugins","enketo-js/extend","jquery.touchswipe"],function(e,t,n){"use strict";function r(r,i){function p(e){a=n(e),this.$=a,this.$nonRepeats={}}var s,o,u,a,f,l,c,h=[];this.init=function(){return f=n(r).clone().appendTo("<original></original>"),s=new e(i),h=h.concat(s.init()),u=new p(r),l=n(r).find(".or-repeat").length>0,u.init(),window.scrollTo&&window.scrollTo(0,0),h},this.ex=function(e,t,n,r,i){return s.evaluate(e,t,n,r,i)},this.getModel=function(){return s},this.getInstanceID=function(){return s.getInstanceID()},this.getInstanceName=function(){return s.getInstanceName()},this.getView=function(){return u},this.getEncryptionKey=function(){return u.$.data("base64rsapublickey")},this.getDataStr=function(){return s.getStr()},this.getRecordName=function(){return u.recordName.get()},this.setRecordName=function(e){return u.recordName.set(e)},this.setEditStatus=function(e){return u.editStatus.set(e)},this.getEditStatus=function(){return u.editStatus.get()},this.getSurveyName=function(){return a.find("#form-title").text()},this.resetView=function(){n("#form-languages").remove(),a.replaceWith(f)},this.resetHTML=this.resetView,this.validate=function(){return u.validateAll()},this.isValid=function(){return u.isValid()},c=function(e,t,r,i,o){var u,f,l,c="",h=e.match(/jr:choice-name\(([^,]+),\s?'(.*?)'\)/);return h?(u=s.evaluate(h[1],t,r,i,o),f=h[2].trim(),l=a.find('[name="'+f+'"]'),l.length>0&&l.prop("nodeName").toLowerCase()==="select"?c=l.find('[value="'+u+'"]').text():l.length>0&&l.prop("nodeName").toLowerCase()==="input"&&(c=l.filter(function(){return n(this).attr("value")===u}).siblings(".option-label.active").text()),e.replace(h[0],'"'+c+'"')):e},p.prototype.init=function(){var n=this;if(!(typeof s!="undefined"&&s instanceof e))return console.error("variable data needs to be defined as instance of FormModel");this.preloads.init(this),this.grosslyViolateStandardComplianceByIgnoringCertainCalcs(),this.calcUpdate(),this.langs.init(),this.repeat.init(this),this.itemsetUpdate(),this.setAllVals(),t.init(),this.branchUpdate(),this.pages.init(),this.outputUpdate(),this.setEventHandlers(),this.editStatus.set(!1),setTimeout(function(){n.progress.update()},0)},p.prototype.pages={active:!1,$current:[],$activePages:n(),init:function(){if(a.hasClass("pages")){var e=a.find(".note, .question, .trigger, .or-appearance-field-list").filter(function(){return n(this).parent().closest(".or-appearance-field-list").length===0}).attr("role","page");if(e.length>1||e.eq(0).hasClass("or-repeat"))this.$formFooter=n(".form-footer"),this.$btnFirst=this.$formFooter.find(".first-page"),this.$btnPrev=this.$formFooter.find(".previous-page"),this.$btnNext=this.$formFooter.find(".next-page"),this.$btnLast=this.$formFooter.find(".last-page"),this.updateAllActive(e),this.toggleButtons(0),this.setButtonHandlers(),this.setRepeatHandlers(),this.setBranchHandlers(),this.setSwipeHandlers(),this.active=!0;this.flipToFirst(),a.show()}},setButtonHandlers:function(){var e=this;this.$btnFirst.off(".pagemode").on("click.pagemode",function(){return e.flipToFirst(),!1}),this.$btnPrev.off(".pagemode").on("click.pagemode",function(){return e.prev(),!1}),this.$btnNext.off(".pagemode").on("click.pagemode",function(){return e.next(),!1}),this.$btnLast.off(".pagemode").on("click.pagemode",function(){return e.flipToLast(),!1})},setSwipeHandlers:function(){var e=this;n(".main").swipe("destroy").swipe({allowPageScroll:"vertical",threshold:75,swipeLeft:function(){e.next()},swipeRight:function(){e.prev()}})},setRepeatHandlers:function(){var e=this;a.off("addrepeat.pagemode").on("addrepeat.pagemode",function(t){e.updateAllActive(),n(t.target).removeClass("current contains-current").find(".current").removeClass("current"),e.flipToPageContaining(n(t.target))}).off("removerepeat.pagemode").on("removerepeat.pagemode",function(t){e.$current.closest("html").length===0&&(e.updateAllActive(),e.flipToPageContaining(n(t.target)))})},setBranchHandlers:function(){var e=this;a.off("changebranch.pagemode").on("changebranch.pagemode",function(){e.updateAllActive(),e.toggleButtons()})},getCurrent:function(){return this.$current},updateAllActive:function(e){e=e||n('.or [role="page"]'),this.$activePages=e.filter(function(){return n(this).closest(".disabled").length===0})},getAllActive:function(){return this.$activePages},getPrev:function(e){return this.$activePages[e-1]},getNext:function(e){return this.$activePages[e+1]},getCurrentIndex:function(){return this.$activePages.index(this.$current)},next:function(){var e,t;this.updateAllActive(),t=this.getCurrentIndex(),e=this.getNext(t),e&&this.flipTo(e,t+1)},prev:function(){var e,t;this.updateAllActive(),t=this.getCurrentIndex(),e=this.getPrev(t),e&&this.flipTo(e,t-1)},setToCurrent:function(e){var t=n(e);t.addClass("current hidden"),this.$current=t.removeClass("hidden").parentsUntil(".or",".or-group, .or-group-data, .or-repeat").addClass("contains-current").end()},flipTo:function(e,t){this.$current.length>0&&this.$current.closest("html").length===1?this.$current[0]!==e&&(this.$current.removeClass("current fade-out").parentsUntil(".or",".or-group, .or-group-data, .or-repeat").removeClass("contains-current"),this.setToCurrent(e),this.focusOnFirstQuestion(e),this.toggleButtons(t)):(this.setToCurrent(e),this.focusOnFirstQuestion(e),this.toggleButtons(t)),window.scrollTo&&window.scrollTo(0,0),n(e).trigger("pageflip.enketo")},flipToFirst:function(){this.updateAllActive(),this.flipTo(this.$activePages[0])},flipToLast:function(){this.updateAllActive(),this.flipTo(this.$activePages.last()[0])},flipToPageContaining:function(e){var t;t=e.closest('[role="page"]'),t=t.length===0?e.find('[role="page"]'):t,this.flipTo(t[0])},focusOnFirstQuestion:function(e){n(e).find(".question:not(.disabled)").filter(function(){return n(this).parentsUntil(".or",".disabled").length===0}).eq(0).find("input, select, textarea").eq(0).trigger("fakefocus")},toggleButtons:function(e){var t=e||this.getCurrentIndex(),n=this.getNext(t),r=this.getPrev(t);this.$btnNext.add(this.$btnLast).toggleClass("disabled",!n),this.$btnPrev.add(this.$btnFirst).toggleClass("disabled",!r),this.$formFooter.toggleClass("end",!n)}},p.prototype.input={getWrapNodes:function(e){var t=this.getInputType(e.eq(0));return t==="fieldset"?e:e.closest(".question, .note")},getProps:function(e){return e.length!==1?console.error("getProps(): no input node provided or multiple"):{path:this.getName(e),ind:this.getIndex(e),inputType:this.getInputType(e),xmlType:this.getXmlType(e),constraint:this.getConstraint(e),calculation:this.getCalculation(e),relevant:this.getRelevant(e),val:this.getVal(e),required:this.isRequired(e),enabled:this.isEnabled(e),multiple:this.isMultiple(e)}},getInputType:function(e){var t;return e.length!==1?"":(t=e.prop("nodeName").toLowerCase(),t==="input"?e.attr("type").length>0?e.attr("type").toLowerCase():console.error("<input> node has no type"):t==="select"?"select":t==="textarea"?"textarea":t==="fieldset"||t==="section"?"fieldset":console.error("unexpected input node type provided"))},getConstraint:function(e){return e.attr("data-constraint")},getRelevant:function(e){return e.attr("data-relevant")},getCalculation:function(e){return e.attr("data-calculate")},getXmlType:function(e){return e.length!==1?console.error("getXMLType(): no input node provided or multiple"):e.attr("data-type-xml")},getName:function(e){var t;return e.length!==1?console.error("getName(): no input node provided or multiple"):(t=e.attr("data-name")||e.attr("name"),t||console.error("input node has no name"))},getIndex:function(e){var t,n,r,i;return e.length!==1?console.error("getIndex(): no input node provided or multiple"):(t=this.getInputType(e),n=this.getName(e),r=this.getWrapNodes(e),t==="radio"&&n!==e.attr("name")?i=this.getWrapNodes(a.find('[data-name="'+n+'"]')):t==="fieldset"&&e.hasClass("or-repeat")?i=this.getWrapNodes(a.find('.or-repeat[name="'+n+'"]')):t==="fieldset"&&e.hasClass("or-group")?i=this.getWrapNodes(a.find('.or-group[name="'+n+'"]')):i=this.getWrapNodes(a.find('[name="'+n+'"]')),i.index(r))},isMultiple:function(e){return this.getInputType(e)==="checkbox"||e.attr("multiple")!==undefined?!0:!1},isEnabled:function(e){return!(e.prop("disabled")||e.parentsUntil(".or",".disabled").length>0)},isRequired:function(e){return e.attr("required")!==undefined&&e.parentsUntil(".or",".or-appearance-label").length===0},getVal:function(e){var t,r=[],i;return e.length!==1?console.error("getVal(): no inputNode provided or multiple"):(t=this.getInputType(e),i=this.getName(e),t==="radio"?this.getWrapNodes(e).find("input:checked").val()||"":t==="checkbox"?(this.getWrapNodes(e).find('input[name="'+i+'"]:checked').each(function(){r.push(n(this).val())}),r):e.val()?n.isArray(e.val())?e.val().join(" ").trim():e.val().trim():"")},setVal:function(e,t,n){var r,i,o;t=t||0;if(this.getInputType(a.find('[data-name="'+e+'"]').eq(0))==="radio"){o=this.getWrapNodes(a.find('[data-name="'+e+'"]')).eq(t).find('input[value="'+n+'"]'),o.prop("checked",!0);return}r=this.getWrapNodes(a.find('[name="'+e+'"]').eq(t)).find('[name="'+e+'"]'),i=this.getInputType(r.eq(0));if(i==="file")return r.eq(0).attr("data-loaded-file-name",n),!1;if(i==="date"||i==="datetime")n=s.node(e,t).convert(n,i);this.isMultiple(r.eq(0))===!0&&(n=n.split(" ")),r.is("[readonly]")&&r.toggleClass("has-value",!!n),r.val(n);return}},p.prototype.setAllVals=function(e,t){var r,i,o,u=this,a=e&&e.attr("name")?e.attr("name"):null;t=typeof t!="undefined"?t:null,s.node(a,t).get().find("*").filter(function(){var e=n(this);return e.children().length===0&&e.text()}).each(function(){var e=n(this);try{o=e.text(),i=e.getXPath("instance"),r=s.node(i).get().index(this),u.input.setVal(i,r,o)}catch(t){console.error(t),h.push("Could not load input field value with name: "+i+" and value: "+o)}});return},p.prototype.langs={init:function(){var e,t=this,r=a.find("#form-languages").attr("data-default-lang"),i=n(".form-language-selector");n("#form-languages").detach().appendTo(i);if(!r||r==="")r=n("#form-languages option").eq(0).attr("value");n("#form-languages").val(r);if(n("#form-languages option").length<2)return;i.removeClass("hide"),n("#form-languages").change(function(r){e=n(this).val(),r.preventDefault(),t.setAll(e)})},setAll:function(e){var t=this;n("#form-languages option").removeClass("active"),n(this).addClass("active"),a.find("[lang]").removeClass("active").filter('[lang="'+e+'"], [lang=""]').filter(function(){var e=n(this);return!e.hasClass("or-form-short")||e.hasClass("or-form-short")&&e.siblings(".or-form-long").length===0}).addClass("active"),a.find("select").each(function(){t.setSelect(n(this))}),a.trigger("changelanguage")},setSelect:function(e){var t,r,i;e.children("option").not('[value=""]').each(function(){var e=n(this);r=e.text(),t=e.attr("value"),i=e.parent("select").siblings(".or-option-translations").children('.active[data-option-value="'+t+'"]').text().trim(),i=typeof i!="undefined"&&i.length>0?i:r,e.text(i)})}},p.prototype.editStatus={set:function(e){e&&e!==a.data("edited")&&a.trigger("edited.enketo"),a.data("edited",e)},get:function(){return!!a.data("edited")}},p.prototype.recordName={set:function(e){a.attr("name",e)},get:function(){return a.attr("name")}},p.prototype.getNodesToUpdate=function(e,t,r){var i,s=null,o=[],u=this;return r=r||{},t=t||"",this.$nonRepeats[e]||(this.$nonRepeats[e]=a.find(t+"["+e+"]").parentsUntil(".or",".calculation, .question, .note, .trigger").filter(function(){return n(this).closest(".or-repeat").length===0})),typeof r.repeatPath!="undefined"&&r.repeatIndex>=0&&(s=a.find('.or-repeat[name="'+r.repeatPath+'"]').eq(r.repeatIndex)),s?i=this.$nonRepeats[e].add(s):i=a,!r.nodes||r.nodes.length===0?o=o.concat([t+"["+e+"]"]):(r.nodes.forEach(function(n){o=o.concat(u.getQuerySelectorsForLogic(t,e,n))}),o=o.concat(u.getQuerySelectorsForLogic(t,e,"*"))),i.find(o.join())},p.prototype.getQuerySelectorsForLogic=function(e,t,n){return[e+"["+t+'*="/'+n+' "]',e+"["+t+'*="/'+n+')"]',e+"["+t+'*="/'+n+',"]',e+"["+t+'$="/'+n+'"]',e+"["+t+'*="/'+n+']"]']},p.prototype.branchUpdate=function(e){function b(e,t,n){var r=s.evaluate(e,"boolean",t,n);return r}function w(e,t){t===!0?S(e):x(e)}function E(e){return!e.hasClass("disabled")&&!e.hasClass("pre-init")}function S(e){var n;E(e)||(v=!0,e.removeClass("disabled pre-init"),t.enable(e),n=e.prop("nodeName").toLowerCase(),n==="label"?e.children("input, select, textarea").prop("disabled",!1):n==="fieldset"?(e.prop("disabled",!1),e.find('*:not(.or-branch) input[type="file"]:not([data-relevant])').prop("disabled",!0).prop("disabled",!1)):e.find("fieldset, input, select, textarea").prop("disabled",!1))}function x(e){var r=e.prop("nodeName").toLowerCase(),i=e.hasClass("pre-init");if(i||E(e))v=!0,e.addClass("disabled"),i?e.removeClass("pre-init"):(e.clearInputs("change"),t.disable(e),e.find(".invalid-required, .invalid-constraint").find("input, select, textarea").each(function(){m.setValid(n(this))})),r==="label"?e.children("input, select, textarea").prop("disabled",!0):r==="fieldset"?e.prop("disabled",!0):e.find("fieldset, input, select, textarea").prop("disabled",!0)}var r,i,o,u,f,c,h,p={},d=[],v=!1,m=this,g=0,y;h=this.getNodesToUpdate("data-relevant","",e),y=l&&a.find(".or-repeat.clone").length>0?!0:!1,h.each(function(){var e=n(this);if(n.inArray(e.attr("name"),d)!==-1)return;i=e.closest(".or-branch");if(i.parent().closest(".disabled").length)return;r={},c=null,r.relevant=m.input.getRelevant(e),r.path=m.input.getName(e);if(i.length!==1){e.parentsUntil(".or","#or-calculated-items").length===0&&console.error("could not find branch node for ",n(this));return}u=y&&i.parentsUntil(".or",".or-repeat").length>0?!0:!1,f=y&&i.parentsUntil(".or",".or-repeat.clone").length>0?!0:!1,r.ind=f?m.input.getIndex(e):0,r.relevant.indexOf("..")===-1&&(u?c=r.relevant+"__"+r.path.substring(0,r.path.lastIndexOf("/"))+"__"+r.ind:c=r.relevant),c&&typeof p[c]!="undefined"?o=p[c]:(o=b(r.relevant,r.path,r.ind),g++,p[c]=o),u||d.push(n(this).attr("name")),w(i,o)}),v&&this.$.trigger("changebranch")},p.prototype.itemsetUpdate=function(e){var t,r,i,o,u=this,f={};o=this.getNodesToUpdate("data-items-path",".itemset-template",e),t=l&&a.find(".or-repeat.clone").length>0?!0:!1,o.each(function(){var e,o,a,l,c,h,p,d,v,m,g,y,b,w,E,S,x;d=n(this);if(d.parentsUntil(".or",".or-branch").parentsUntil(".or",".disabled").length)return;v={},m=d.data(),g=d.prop("nodeName").toLowerCase(),y=g==="label"?d.children("input").eq(0):d.parent("select"),b=d.closest("label, select").siblings(".itemset-labels"),w=d.attr("data-items-path"),E=b.attr("data-label-type"),S=b.attr("data-label-ref"),x=b.attr("data-value-ref"),h=u.input.getName(y),r=t&&y.parentsUntil(".or",".or-repeat").length>0?!0:!1,i=t&&y.parentsUntil(".or",".or-repeat.clone").length>0?!0:!1,c=i?u.input.getIndex(y):0;if(typeof f[w]!="undefined")l=f[w];else{var T=!0;l=n(s.evaluate(w,"nodes",h,c,T)),r||(f[w]=l)}v.length=l.length,v.text=l.text();if(v.length===m.length&&v.text===m.text)return;d.data(v),d.closest(".question").clearInputs("change").find(g).not(d).remove(),d.parent("select").siblings(".or-option-translations").empty(),l.each(function(){var t=n(this);p=t.children(S).text(),e=n("<root/>"),d.clone().appendTo(e).removeClass("itemset-template").addClass("itemset").removeAttr("data-items-path"),o=E==="itext"&&b.find('[data-itext-id="'+p+'"]').length>0?b.find('[data-itext-id="'+p+'"]').clone():n('<span class="option-label active" lang="">'+p+"</span>"),a=t.children(x).text(),e.find("[value]").attr("value",a),g==="label"?(e.find("input").after(o),b.before(e.find(":first"))):g==="option"&&(o.length===1&&e.find("option").text(o.text()),o.attr("data-option-value",a).attr("data-itext-id","").appendTo(b.siblings(".or-option-translations")),d.siblings().addBack().last().after(e.find(":first")))}),y.prop("nodeName").toLowerCase()==="select"&&(u.langs.setSelect(y),y.trigger("changeoption"))})},p.prototype.outputUpdate=function(e){var t,r,i,o,u,f,c,h,p,d={},v="",m=this;p=this.getNodesToUpdate("data-value",".or-output",e),r=l&&a.find(".or-repeat.clone").length>0,p.each(function(){f=n(this);if(f.closest(".or-branch").parent().closest(".disabled").length)return;t=f.attr("data-value"),u=f.closest(".question, .note, .or-group").find("[name]").eq(0),c=u.length?m.input.getName(u):undefined,i=r&&f.parentsUntil(".or",".or-repeat").length>0,o=i&&f.parentsUntil(".or",".or-repeat.clone").length>0,h=o?m.input.getIndex(u):0,typeof d[t]!="undefined"?v=d[t]:(v=s.evaluate(t,"string",c,h,!0),i||(d[t]=v)),f.text!==v&&f.text(v)})},p.prototype.grosslyViolateStandardComplianceByIgnoringCertainCalcs=function(){var e=a.find('[name$="/meta/instanceID"][data-calculate]');e.length>0&&e.removeAttr("data-calculate")},p.prototype.calcUpdate=function(e){var t,r=this;e=e||{},t=this.getNodesToUpdate("data-calculate","",e),t=t.add(this.getNodesToUpdate("data-relevant","[data-calculate]",e)),t.each(function(){function b(e){p=c(p,"string",l,e),t=g&&p?s.evaluate(p,"string",l,e):"",o.setIndex(e),i=o.setVal(t,v,d),r.input.setVal(l,e,t)}var t,i,o,u,a,f,l,h,p,d,v,m,g,y;y=n(this),l=r.input.getName(y),h=l.lastIndexOf("/")!==-1?l.substring(l.lastIndexOf("/")+1):l,p=r.input.getCalculation(y),d=r.input.getXmlType(y),v=r.input.getConstraint(y),m=r.input.getRelevant(y),g=m?s.evaluate(m,"boolean",l):!0,o=s.node(l),u=o.get(),u.length>1&&e.repeatPath&&l.indexOf(e.repeatPath)!==-1?(a=s.node(e.repeatPath,e.repeatIndex).get().find(h),f=n(u).index(a),b(f)):u.length===1?(f=0,b(f)):u.each(function(e){b(e)})})},p.prototype.preloads={init:function(e){var t,r,i,o,u,f,l,c,h,p,d=this;a.find("#or-preload-items input").each(function(){p=n(this),c=e.input.getProps(p),t=p.attr("data-preload").toLowerCase(),r=p.attr("data-preload-params").toLowerCase(),typeof d[t]!="undefined"?(l=s.node(c.path,c.index),o=l.getVal()[0],u=d[t]({param:r,curVal:o,dataNode:l}),l.setVal(u,null,c.xmlType)):console.log('Preload "'+t+'" not supported. May or may not be a big deal.')}),f=s.node("/*/meta/*"),f.get().each(function(){t=null,i=n(this).prop("nodeName"),l=s.node("/*/meta/"+i),o=l.getVal()[0];if(a.find('#or-preload-items input[name$="/meta/'+i+'"][data-preload]').length===0)switch(i){case"instanceID":t="instance",h="string",r="";break;case"timeStart":t="timestamp",h="datetime",r="start";break;case"timeEnd":t="timestamp",h="datetime",r="end";break;case"deviceID":t="property",h="string",r="deviceid";break;case"userID":t="property",h="string",r="username"}t&&l.setVal(d[t]({param:r,curVal:o,dataNode:l}),null,h)})},timestamp:function(e){var t;return e.param==="start"?e.curVal.length>0?e.curVal:s.evaluate("now()","string"):e.param==="end"?(a.on("beforesave",function(){t=s.evaluate("now()","string"),e.dataNode.setVal(t,null,"datetime")}),s.evaluate("now()","string")):"error - unknown timestamp parameter"},date:function(e){var t,n,r,i;return e.curVal.length===0?(t=new Date(s.evaluate("today()","string")),n=t.getFullYear().toString().pad(4),r=(t.getMonth()+1).toString().pad(2),i=t.getDate().toString().pad(2),n+"-"+r+"-"+i):e.curVal},property:function(e){var t,n,r;t=function(e,t,n,r){if(o)return o[e];t=document.cookie.split("; "),o={};for(r=t.length-1;r>=0;r--)n=t[r].split("="),n[1]=decodeURIComponent(n[1]),n[1].substr(0,2)==="s:"&&(n[1]=n[1].slice(2),n[1]=n[1].slice(0,n[1].lastIndexOf("."))),o[n[0]]=decodeURIComponent(n[1]);return o[e]};if(e.curVal.length===0){n="no "+e.param+" property in enketo";switch(e.param){case"deviceid":r=t("__enketo_meta_deviceid")||"Error: could not determine deviceID";break;case"username":r=t("__enketo_meta_uid");break;default:r=n}return r}return e.curVal},context:function(e){return e.curVal.length===0?e.param==="application"?"enketo":e.param+" not supported in enketo":e.curVal},patient:function(e){return e.curVal.length===0?"patient preload not supported in enketo":e.curVal},user:function(e){return e.curVal.length===0?"user preload item not supported in enketo yet":e.curVal},uid:function(e){return e.curVal.length===0?"no uid yet in enketo":e.curVal},instance:function(e){var t=e.curVal.length>0?e.curVal:s.evaluate('concat("uuid:", uuid())',"string");return a.data({instanceID:t}),t}},p.prototype.repeat={init:function(e){var t,r,i,o,u,f,l,c=this;this.formO=e,a.find(".or-repeat").prepend('<span class="repeat-number"></span>'),a.find(".or-repeat:not([data-repeat-fixed])").append('<div class="repeat-buttons"><button type="button" class="btn btn-default repeat"><i class="icon icon-plus"> </i></button><button type="button" disabled class="btn btn-default remove"><i class="icon icon-minus"> </i></button></div>'),a.on("click","button.repeat:enabled",function(){return c.clone(n(this).closest(".or-repeat")),!1}),a.on("click","button.remove:enabled",function(){return c.remove(n(this).closest(".or-repeat.clone")),!1}),u=function(e,h){r=e.attr("data-repeat-count")||"",t=r.length>0?parseInt(s.node(r).getVal()[0],10):0,l=a.find('.or-repeat[name="'+e.attr("name")+'"]').index(e),f=s.node(e.attr("name"),l).get(),i=f.siblings(f.prop("nodeName")).addBack().length,o=t>i?t:i,o>1&&c.clone(e.siblings().addBack().last(),o-1,!0),e.siblings(".or-repeat").addBack().find(".or-repeat").filter(function(){return n(this).parentsUntil(".or",".or-repeat").length===h}).each(function(){u(n(this),h+1)})},a.find(".or-repeat").filter(function(){return n(this).parentsUntil(".or",".or-repeat").length===0}).each(function(){u(n(this),1)})},clone:function(e,r,i){var o,u,f,l,c,h,p,d=this;r=r||1;if(e.length!==1)return console.error("Nothing to clone"),!1;o=e.siblings(".or-repeat"),u=e.hasClass("clone")?o.not(".clone").eq(0):e,f=u.clone(!0,!0),p=u.attr("name"),f.addClass("clone").find(".clone").remove(),f.find(".invalid-required, .invalid-constraint").find("input, select, textarea").each(function(){d.formO.setValid(n(this))}),c=a.find('.or-repeat[name="'+p+'"]').index(e),f.clearInputs(""),h=r+c;for(;c<h;c++)f.find(".option-wrapper").each(this.fixRadioNames),i||t.destroy(f),f.insertAfter(e),p.length>0&&c>=0&&s.cloneRepeat(p,c),f.trigger("addrepeat",c+1),i?d.formO.calcUpdate({repeatPath:p,repeatIndex:c+1}):t.init(f),o=o.add(f),f=f.clone();return l=o.add(e).add(o.find(".or-repeat")),this.numberRepeats(l),this.toggleButtons(l),!0},remove:function(e){var t=600,n=this,r=e.prev(".or-repeat"),i=e.attr("name"),o=a.find('.or-repeat[name="'+i+'"]').index(e),u=e.siblings(".or-repeat");e.hide(t,function(){e.remove(),n.numberRepeats(u),n.toggleButtons(u),r.trigger("removerepeat"),s.node(i,o).remove()})},fixRadioNames:function(e,t){n(t).find('input[type="radio"]').attr("name",Math.floor(Math.random()*1e7+1))},toggleButtons:function(e){var t,r;e=!e||e.length===0?a:e,e.each(function(){t=n(this),r=t.siblings(".or-repeat").addBack(),r.children(".repeat-buttons").find("button.repeat, button.remove").prop("disabled",!0),r.last().children(".repeat-buttons").find("button.repeat").prop("disabled",!1),r.children(".repeat-buttons").find("button.remove").not(":first").prop("disabled",!1)})},numberRepeats:function(e){e.each(function(){var e,t,r,i=n(this);i.prev(".or-repeat").length===0&&(e=n(this).siblings(".or-repeat"),t=e.length+1,t>1?(i.find(".repeat-number").text("1"),r=2,e.each(function(){n(this).find(".repeat-number").eq(0).text(r),r++})):i.find(".repeat-number").eq(0).empty())})}},p.prototype.setEventHandlers=function(){var e=this;a.attr("onsubmit","return false;"),a.on("blur",'input:not([type="text"], [type="radio"], [type="checkbox"])',function(){var e=n(this);typeof e.prop("validity").badInput!="undefined"&&e.prop("validity").badInput&&e.val("")}),a.on("change.file validate","input:not(.ignore), select:not(.ignore), textarea:not(.ignore)",function(t){var r,i,o,u=n(this),f={path:e.input.getName(u),inputType:e.input.getInputType(u),xmlType:e.input.getXmlType(u),enabled:e.input.isEnabled(u),constraint:e.input.getConstraint(u),val:e.input.getVal(u),required:e.input.isRequired(u)},l=function(){return o||(f.ind=e.input.getIndex(u),o=s.node(f.path,f.ind)),o};f.val.length>0&&f.inputType==="file"&&u[0].files[0]&&u[0].files[0].size>0&&(f.val=u[0].files[0].name),t.type==="validate"?!f.enabled||f.inputType==="hidden"?r=!0:!!f.constraint||f.xmlType!=="string"&&f.xmlType!=="select"&&f.xmlType!=="select1"&&f.xmlType!=="binary"?r=l().validate(f.constraint,f.xmlType):r=!0:(r=l().setVal(f.val,f.constraint,f.xmlType),r=r!==!1||f.xmlType!=="geotrace"&&f.xmlType!=="geoshape"?r:null),i=!f.enabled||f.inputType==="hidden"||!f.required||l().getVal()[0].length!==0,i===!1?(e.setValid(u,"constraint"),t.type==="validate"&&e.setInvalid(u,"required")):(e.setValid(u,"required"),typeof r!="undefined"&&r===!1?e.setInvalid(u,"constraint"):r!==null&&e.setValid(u,"constraint")),t.type==="change"&&a.trigger("valuechange.enketo")}),a.on("focus fakefocus","input:not(.ignore), select:not(.ignore), textarea:not(.ignore)",function(t){e.progress.update(t.target)}),a.on("focus blur fakefocus fakeblur","input:not(.ignore), select:not(.ignore), textarea:not(.ignore)",function(t){var r=n(this),i=e.input.getProps(r),s=r.closest(".question"),o=s.find("legend").eq(0),u=s.hasClass("invalid-required")||s.hasClass("invalid-constraint"),a=r.parentsUntil(".or",".or-appearance-list-nolabel").length>0,f=s.find(".required-subtle"),l=n('<span class="required-subtle" style="color: transparent;">Required</span>');if(t.type==="focusin"||t.type==="fakefocus")s.addClass("focus"),i.required&&f.length===0&&!a?(f=n(l),o.length>0?o.append(f):f.insertBefore(this),u||f.show(function(){n(this).removeAttr("style")})):!u;else if(t.type==="focusout"||t.type==="fakeblur")s.removeClass("focus"),i.required&&i.val.length>0?f.remove():u||f.removeAttr("style")}),s.$.on("dataupdate",function(t,n){e.calcUpdate(n),e.branchUpdate(n),e.outputUpdate(n),e.itemsetUpdate(n),e.editStatus.set(!0)}),a.on("addrepeat",function(t,r){var i=n(t.target);e.setAllVals(i,r),e.calcUpdate({repeatPath:i.attr("name"),repeatIndex:r}),e.progress.update()}),a.on("removerepeat",function(){e.progress.update()}),a.on("changelanguage",function(){e.outputUpdate()})},p.prototype.setValid=function(e,t){var n=t?"invalid-"+t:"invalid-constraint invalid-required";this.input.getWrapNodes(e).removeClass(n)},p.prototype.setInvalid=function(e,t){t=t||"constraint",this.input.getWrapNodes(e).addClass("invalid-"+t).find(".required-subtle").attr("style","color: transparent;")},p.prototype.validateAll=function(){var e,t=this;return a.find("fieldset:disabled input, fieldset:disabled select, fieldset:disabled textarea, input:disabled, select:disabled, textarea:disabled").each(function(){t.setValid(n(this))}),a.find(".question").each(function(){n(this).find("input:not(.ignore):not(:disabled), select:not(.ignore):not(:disabled), textarea:not(.ignore):not(:disabled)").eq(0).trigger("validate")}),e=a.find(".invalid-required, .invalid-constraint").eq(0),e.length>0&&window.scrollTo&&(this.pages.active&&this.pages.flipToPageContaining(e),window.scrollTo(0,e.offset().top-50)),e.length===0},p.prototype.progress={status:0,lastChanged:null,$all:null,updateTotal:function(){this.$all=a.find(".question").not(".disabled").filter(function(){return n(this).parentsUntil(".or",".disabled").length===0})},update:function(e){var t;(!this.$all||!e)&&this.updateTotal(),this.lastChanged=e||this.lastChanged,t=Math.round((this.$all.index(n(this.lastChanged).closest(".question"))+1)*100/this.$all.length),t>0&&t!==this.status&&(this.status=t,a.trigger("progressupdate.enketo",t))},get:function(){return this.status}},p.prototype.isValid=function(){return a.find(".invalid-required, .invalid-constraint").length>0?!1:!0},p.prototype.addPageBreaks=function(){}}return r});