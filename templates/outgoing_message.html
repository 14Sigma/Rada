<div class="message outgoing-message row-fluid clickable">
  <div class="select-row">
    <input type="checkbox" name="select-row-checkbox" />
  </div>
  <div class="direction-icon">
    <i class="icon-envelope icon-muted"></i>
  </div>
  <div class="contact-info">
    <b>To:</b> {@contact entities="{related_entities}" messages="{tasks}"/}
  </div>
  <div class="msg">
    {tasks[0].messages[0].message}
  </div>
  <div class="icons">
    {@ifHasState array="{tasks}" state="sent"}
    <span class="label label-success" title="{@countByState array1="{tasks}" array2="{scheduled_tasks}" state="sent"/} messages sent">
      {@countByState array1="{tasks}" array2="{scheduled_tasks}" state="sent"/}
        <i class="icon-envelope"></i>
      </span>
    {/ifHasState}
    {@ifHasState array="{tasks}" state="pending"}
    <span class="label label-info" title="{@countByState array1="{tasks}" array2="{scheduled_tasks}" state="pending"/} messages pending">
      {@countByState array1="{tasks}" array2="{scheduled_tasks}" state="pending"/}
        <i class="icon-time"></i>
      </span>
    {/ifHasState}
  </div>
  <div class="timestamp" title="{@formatDate timestamp="{tasks[0].timestamp}"/}">
  {?tasks[0].timestamp}
    {@formatDate timestamp="{tasks[0].timestamp}" format="MMM DD HH:mm"/}
  {/tasks[0].timestamp}
  </div>
  <div class="add-message"></div>
</div>
<div class="extended">
  <div class="row-fluid">
    <div class="inset span12 msg-full">
    {#tasks}
      <p class="pull-right">
        <span class="tasks-state-{state}">{state}</span>
      </p>
      {#messages}
      <div>
        <b>To:</b>
        {#facility}
          {?clinic}
            {?clinic.parent.parent.name}
              {clinic.parent.parent.name}
              <i class="icon-double-angle-right"></i>
            {/clinic.parent.parent.name}
            {?clinic.parent.name}
              {clinic.parent.name}
              <i class="icon-double-angle-right"></i>
            {/clinic.parent.name}
            {?clinic.name}
              {clinic.name}
            {/clinic.name}
            {?clinic.contact.rc_code}
              <span class="label">{clinic.contact.rc_code}</span>
            {/clinic.contact.rc_code}
            {?clinic.contact.name}
              {clinic.contact.name}
            {/clinic.contact.name}
            {?clinic.contact.phone}
              {clinic.contact.phone}
            {/clinic.contact.phone}
          {:else}
            {to}
          {/clinic}
        {/facility}
        {^facility}
          {to}
        {/facility}
      </div>
        <p>
          <b>Sent by:</b> {sent_by}
          {?from}{from}{/from}
          {?timestamp}<br/><b>Date:</b> {@formatDate timestamp="{timestamp}"/}{/timestamp}
        </p>
        <p><pre>{message}</pre></p>
      {/messages}
    {/tasks}
    </div>
  </div>
</div>
