<!doctype html> 
<html lang="en-us"> 
  <head> 
    <meta charset="utf-8">
    <title>{title}</title> 
    <link rel="stylesheet" type="text/css" href="{baseURL}/static/css/app.css" />
  </head>
  <body> 
    <div class="navbar navbar-fixed">
      <div class="navbar-inner">
        <div class="container">
          <p class="brand"><a href="{baseURL}/" class="kujua">Kujua</a> Export <span class="version">v{settings.version}</span></p>
          <ul class="nav pull-right">
            <li class="home"><a href="{baseURL}/">Home</a></li>
            <li class="docs"><a href="{baseURL}/docs/">Docs</a></li>
            <li class="dropdown">
            <a class="dropdown-toggle">Admin <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="{baseURL}/../_view/sms_messages?include_docs=true">Raw Messages</a></li>
                <li><a href="{baseURL}/test">Run Tests</a></li>
                <li><a href="https://github.com/medic/kujua-export">Source Code</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="page-header">
      <div class="container">
        <h1>&nbsp;</h1>
      </div>
    </div>
    <div class="container">
      <div class="content">
        <div id="content">
          {content|s}
        </div>
      </div>
      <div id="footer">
        <p>&copy; <span id="year">2011</span> Medic Mobile</p>
      </div>
    </div>
    <script src="{baseURL}/static/js/jquery-1.7.min.js"></script>
    <script src="{baseURL}/static/js/json2.js"></script>
    <script src="{baseURL}/modules.js"></script>
    <script type="text/javascript">
var db = require('db').current(),
    templates = require('duality/templates'),
    smsforms = require('views/lib/smsforms'),
    _ = require('underscore')._,
    forms = {},
    showdown = require('showdown').Showdown,
    sd = new showdown.converter();

$(function() {
  if ($('#forms').get(0)) {
    $('.page-header h1').text('SMS Forms Data');
    // render available downloads based on data available
    db.getView('kujua-export', 'sms_message_values', function(err, data) {
        if (err) {
            return alert(err);
        }
        for (var i = 0; i < data.rows.length; i++) {
            var key = data.rows[i].key[0];
            if (smsforms[key]) {
              forms[key] = 1;
            }
        }
        $('#forms').html(
            templates.render(
                'sms_forms_data.html', {}, {forms:_.keys(forms)}));
        $('.nav .home').addClass('active');
    });
  }

  var renderDoc = function(data, slug) {
    $('#docs-body').html(sd.makeHtml(data));
    var title = $('#docs-body h1:first-child').text();
    $('#docs-body h1:first-child').remove();
    $('.page-header h1').text(title);
    //html(.html('SMS Data Collection Setup');
    $('.nav .docs').addClass('active');

    // render TOC unless loading the index
    if (slug !== 'index') {
      var ul = $('<ul/>');
      $('#docs-body h2, #docs-body h3').each(function(idx, el) {
        var header = $(el),
            title = header.text(),
            id = header.attr('id');
        if (el.tagName === 'H2') {
          ul.append(
            $('<li/>').append(
              $('<a/>').attr('href', '#'+id).text(title)));
        } else {
          ul.append(
            $('<li class="subhead"/>').append(
              $('<a/>').attr('href', '#'+id).text(title)));
        }
      });
      $('.sections').append(ul);
      $('.sections').show();
    } else {
      $('.sections').hide();
    }

    // make large images zoomable
    $('#docs-body img').each(function(idx, el) {
        var t =  $("<img/>"),
            width = 0,
            height = 0;
        t.attr("src", $(el).attr("src"));
        t.load(function() { 
            width = this.width; 
            height = this.height; 
            $(el).parent().addClass('images');
            if (width > 960) {
              $(el).parent().addClass('zoom');
              $(el).parent().bind('click', function() {
                var p = $(this);
                if (p.attr('style')) {
                  p.attr('style',null);
                } else {
                  p.css({'width': width});
                }
              });
            };
        });
    });
  }
  if ($('#docs').get(0)) {
    var href = $(location).attr('href'),
        slug = href.split('/').pop().split(/[^\w]+/)[0] || 'index';
    $.ajax({
        url: '../../docs/'+ slug +'.md',
        success: function(data) { renderDoc(data, slug); },
        error: function(jqXHR, textStatus, errorThrown) {
          alert(textStatus + ' ' + errorThrown);
        }
    });
  }

  // Dynamic year for footer copyright
  var currentYear = (new Date).getFullYear();
  $("#year").text( (new Date).getFullYear() );

  // Admin menu control
  $('.dropdown-toggle').click(function() {
    $('.dropdown-menu').toggle(300);
  });
});
    </script>
  </body>
</html>
